<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="-Flink," />





  <link rel="alternate" href="/atom.xml" title="ç‰å…†çš„åšå®¢" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="flink ç‰©ç†è®¡åˆ’ç”Ÿæˆï¼Œä¸»è¦æ˜¯ JobManager è¿è¡Œæ—¶çš„æŠ½è±¡å’Œç®¡ç†ï¼Œå‰ä¸€ç« èŠ‚ä¸­æœ‰ä»‹ç»è¿‡ flink çš„é€»è¾‘è®¡åˆ’æŠ½è±¡ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œflink è¿›ä¸€æ­¥å°†é€»è¾‘è®¡åˆ’æŠ½è±¡æˆä¸æ‰§è¡ŒèŠ‚ç‚¹ä¿¡æ¯ç´§å¯†ç›¸å…³çš„ç‰©ç†è®¡åˆ’ï¼Œæ¥å¯¹ä½œä¸šçš„è°ƒåº¦ã€æ‰§è¡Œè¿›è¡Œç®¡ç†">
<meta property="og:type" content="article">
<meta property="og:title" content="flink ç‰©ç†è®¡åˆ’ç”Ÿæˆ">
<meta property="og:url" content="https://danny0405.github.io/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/index.html">
<meta property="og:site_name" content="ç‰å…†çš„åšå®¢">
<meta property="og:description" content="flink ç‰©ç†è®¡åˆ’ç”Ÿæˆï¼Œä¸»è¦æ˜¯ JobManager è¿è¡Œæ—¶çš„æŠ½è±¡å’Œç®¡ç†ï¼Œå‰ä¸€ç« èŠ‚ä¸­æœ‰ä»‹ç»è¿‡ flink çš„é€»è¾‘è®¡åˆ’æŠ½è±¡ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œflink è¿›ä¸€æ­¥å°†é€»è¾‘è®¡åˆ’æŠ½è±¡æˆä¸æ‰§è¡ŒèŠ‚ç‚¹ä¿¡æ¯ç´§å¯†ç›¸å…³çš„ç‰©ç†è®¡åˆ’ï¼Œæ¥å¯¹ä½œä¸šçš„è°ƒåº¦ã€æ‰§è¡Œè¿›è¡Œç®¡ç†">
<meta property="og:image" content="https://danny0405.github.io/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/jobclient-to-jobmanager.png">
<meta property="og:image" content="https://danny0405.github.io/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/flink-job-vertex-to-execution.png">
<meta property="og:image" content="https://danny0405.github.io/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/job-graph-node-sort.png">
<meta property="og:image" content="https://danny0405.github.io/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/execution-vertex-one-to-one.png">
<meta property="og:image" content="https://danny0405.github.io/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/execution-one-many.png">
<meta property="og:updated_time" content="2017-02-06T10:32:18.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="flink ç‰©ç†è®¡åˆ’ç”Ÿæˆ">
<meta name="twitter:description" content="flink ç‰©ç†è®¡åˆ’ç”Ÿæˆï¼Œä¸»è¦æ˜¯ JobManager è¿è¡Œæ—¶çš„æŠ½è±¡å’Œç®¡ç†ï¼Œå‰ä¸€ç« èŠ‚ä¸­æœ‰ä»‹ç»è¿‡ flink çš„é€»è¾‘è®¡åˆ’æŠ½è±¡ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œflink è¿›ä¸€æ­¥å°†é€»è¾‘è®¡åˆ’æŠ½è±¡æˆä¸æ‰§è¡ŒèŠ‚ç‚¹ä¿¡æ¯ç´§å¯†ç›¸å…³çš„ç‰©ç†è®¡åˆ’ï¼Œæ¥å¯¹ä½œä¸šçš„è°ƒåº¦ã€æ‰§è¡Œè¿›è¡Œç®¡ç†">
<meta name="twitter:image" content="https://danny0405.github.io/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/jobclient-to-jobmanager.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://danny0405.github.io/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/"/>





  <title> flink ç‰©ç†è®¡åˆ’ç”Ÿæˆ | ç‰å…†çš„åšå®¢ </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-88432446-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?1bde8b788c41c89cd3d082567500188c";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">ç‰å…†çš„åšå®¢</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">å¿ƒå¦‚æ­¢æ°´</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            å…³äº
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            æœç´¢
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://danny0405.github.io/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="chenyuzhao">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.png">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="ç‰å…†çš„åšå®¢">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="ç‰å…†çš„åšå®¢" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                flink ç‰©ç†è®¡åˆ’ç”Ÿæˆ
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-06T17:12:21+08:00">
                2017-02-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Streaming/" itemprop="url" rel="index">
                    <span itemprop="name">Streaming</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          

          
              <div class="post-description">
                  flink ç‰©ç†è®¡åˆ’ç”Ÿæˆï¼Œä¸»è¦æ˜¯ JobManager è¿è¡Œæ—¶çš„æŠ½è±¡å’Œç®¡ç†ï¼Œå‰ä¸€ç« èŠ‚ä¸­æœ‰ä»‹ç»è¿‡ flink çš„é€»è¾‘è®¡åˆ’æŠ½è±¡ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œflink è¿›ä¸€æ­¥å°†é€»è¾‘è®¡åˆ’æŠ½è±¡æˆä¸æ‰§è¡ŒèŠ‚ç‚¹ä¿¡æ¯ç´§å¯†ç›¸å…³çš„ç‰©ç†è®¡åˆ’ï¼Œæ¥å¯¹ä½œä¸šçš„è°ƒåº¦ã€æ‰§è¡Œè¿›è¡Œç®¡ç†
              </div>
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¸Šä¸€èŠ‚è®²åˆ°ä¸šåŠ¡ä»£ç <code>StreamExecutionEnvironment.execute()</code>ä¼šè§¦å‘jobçš„å®¢æˆ·ç«¯é€»è¾‘è®¡åˆ’<code>JobGraph</code> çš„ç”Ÿæˆï¼Œä¹‹åæ˜¯å®¢æˆ·ç«¯ä¸<code>JobManager</code>çš„äº¤äº’è¿‡ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ClusterClient line388</span></div><div class="line"><span class="function"><span class="keyword">public</span> JobExecutionResult <span class="title">run</span><span class="params">(JobGraph jobGraph, ClassLoader classLoader)</span> <span class="keyword">throws</span> ProgramInvocationException </span>&#123;</div><div class="line"></div><div class="line">   waitForClusterToBeReady();</div><div class="line"></div><div class="line">   <span class="keyword">final</span> LeaderRetrievalService leaderRetrievalService;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">      leaderRetrievalService = LeaderRetrievalUtils.createLeaderRetrievalService(flinkConfig);</div><div class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ProgramInvocationException(<span class="string">"Could not create the leader retrieval service"</span>, e);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">      logAndSysout(<span class="string">"Submitting job with JobID: "</span> + jobGraph.getJobID() + <span class="string">". Waiting for job completion."</span>);</div><div class="line">      <span class="keyword">this</span>.lastJobExecutionResult = JobClient.submitJobAndWait(actorSystemLoader.get(),</div><div class="line">         leaderRetrievalService, jobGraph, timeout, printStatusDuringExecution, classLoader);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.lastJobExecutionResult;</div><div class="line">   &#125; <span class="keyword">catch</span> (JobExecutionException e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ProgramInvocationException(<span class="string">"The program execution failed: "</span> + e.getMessage(), e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>leaderRetrievalService = LeaderRetrievalUtils.createLeaderRetrievalService(flinkConfig);</code>æ˜¯å¯åŠ¨è·å– leader JobManager çš„æœåŠ¡ï¼Œflink æ”¯æŒ JobManager HAï¼Œéœ€è¦é€šè¿‡ leader JobManager è·å–å½“å‰çš„ leader JobManagerï¼Œç¨å¾®ä»‹ç»ä¸‹è¿™ä¸ªæœåŠ¡ï¼š</p>
<h2 id="JobManager-Leader-é€‰ä¸¾"><a href="#JobManager-Leader-é€‰ä¸¾" class="headerlink" title="JobManager Leader é€‰ä¸¾"></a>JobManager Leader é€‰ä¸¾</h2><p>å…ˆæ¥çœ‹è·å– <code>LeaderRetrievalService</code>çš„é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//LeaderRetrievalUtils line61</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LeaderRetrievalService <span class="title">createLeaderRetrievalService</span><span class="params">(Configuration configuration)</span></span></div><div class="line">   <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">   RecoveryMode recoveryMode = getRecoveryMode(configuration);</div><div class="line"></div><div class="line">   <span class="keyword">switch</span> (recoveryMode) &#123;</div><div class="line">      <span class="keyword">case</span> STANDALONE:</div><div class="line">         <span class="keyword">return</span> StandaloneUtils.createLeaderRetrievalService(configuration);</div><div class="line">      <span class="keyword">case</span> ZOOKEEPER:</div><div class="line">         <span class="keyword">return</span> ZooKeeperUtils.createLeaderRetrievalService(configuration);</div><div class="line">      <span class="keyword">default</span>:</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Recovery mode "</span> + recoveryMode + <span class="string">" is not supported."</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆ flink ä¼šä¾æ®é…ç½®è·å– <code>RecoveryMode</code>ï¼Œ<code>RecoveryMode</code>ä¸€å…±ä¸¤ç§ï¼š<em>STANDALONE</em>å’Œ<em>ZOOKEEPER</em>ã€‚å¦‚æœç”¨æˆ·é…ç½®çš„æ˜¯<em>STANDALONE</em>ï¼Œä¼šç›´æ¥å»é…ç½®ä¸­è·å–<code>JobManager</code>çš„åœ°å€ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»<code>ZOOKEEPER</code>æ¨¡å¼ä¸‹çš„<code>JobManager</code>leaderçš„å‘ç°è¿‡ç¨‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ZooKeeperUtils line141</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZooKeeperLeaderRetrievalService <span class="title">createLeaderRetrievalService</span><span class="params">(</span></span></div><div class="line">      Configuration configuration) <span class="keyword">throws</span> Exception &#123;</div><div class="line">   CuratorFramework client = startCuratorFramework(configuration);</div><div class="line">   String leaderPath = configuration.getString(ConfigConstants.ZOOKEEPER_LEADER_PATH,</div><div class="line">         ConfigConstants.DEFAULT_ZOOKEEPER_LEADER_PATH);</div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ZooKeeperLeaderRetrievalService(client, leaderPath);</div><div class="line">&#125;</div><div class="line"></div><div class="line">...</div><div class="line"><span class="comment">//ZooKeeperLeaderRetrievalService line103</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nodeChanged</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			LOG.debug(<span class="string">"Leader node has changed."</span>);</div><div class="line"></div><div class="line">			ChildData childData = cache.getCurrentData();</div><div class="line"></div><div class="line">			String leaderAddress;</div><div class="line">			UUID leaderSessionID;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (childData == <span class="keyword">null</span>) &#123;</div><div class="line">				leaderAddress = <span class="keyword">null</span>;</div><div class="line">				leaderSessionID = <span class="keyword">null</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">byte</span>[] data = childData.getData();</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (data == <span class="keyword">null</span> || data.length == <span class="number">0</span>) &#123;</div><div class="line">					leaderAddress = <span class="keyword">null</span>;</div><div class="line">					leaderSessionID = <span class="keyword">null</span>;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(data);</div><div class="line">					ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(bais);</div><div class="line"></div><div class="line">					leaderAddress = ois.readUTF();</div><div class="line">					leaderSessionID = (UUID) ois.readObject();</div></pre></td></tr></table></figure>
<p>è¿™é‡Œ flink ä¼šé¦–å…ˆå°è¯•è¿æ¥ zookeeperï¼Œåˆ©ç”¨ zookeeperçš„leaderé€‰ä¸¾æœåŠ¡å‘ç°leaderèŠ‚ç‚¹çš„åœ°å€å’Œå½“å‰çš„ sessionidï¼Œsession idçš„ä½œç”¨ä»‹ç»<code>JobManager</code>çš„æ—¶å€™ä¼šè¯¦ç»†è¯´æ˜</p>
<h2 id="å®¢æˆ·ç«¯JobGraphçš„æäº¤"><a href="#å®¢æˆ·ç«¯JobGraphçš„æäº¤" class="headerlink" title="å®¢æˆ·ç«¯JobGraphçš„æäº¤"></a>å®¢æˆ·ç«¯JobGraphçš„æäº¤</h2><p>å®¢æˆ·ç«¯çš„<code>JobGraph</code>ç”Ÿæˆä¹‹åï¼Œé€šè¿‡ä¸Šé¢çš„<code>LeaderRetrivalService</code>è·å–<code>JobManager</code>çš„åœ°å€ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å°†<code>JobGraph</code>æäº¤ç»™<code>JobManager</code>å»æ‰§è¡Œã€‚flink çš„æ ¸å¿ƒè¿›ç¨‹é€šä¿¡æ˜¯é€šè¿‡ Akka æ¥å®Œæˆçš„ï¼Œ<code>JobManager</code>ã€<code>TaskManager</code>éƒ½æ˜¯ä¸€ä¸ª Akka systemï¼Œæ‰€ä»¥è¿™é‡Œçš„æäº¤é¦–å…ˆéœ€è¦ç”Ÿæˆä¸€ä¸ªå®¢æˆ·ç«¯actorä¸<code>JobManager</code>äº¤äº’ï¼Œç„¶åæ‰§è¡Œrpcå‘½ä»¤ï¼Œå…·ä½“è§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//JobClient line98</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobExecutionResult <span class="title">submitJobAndWait</span><span class="params">(</span></span></div><div class="line">      ActorSystem actorSystem,</div><div class="line">      LeaderRetrievalService leaderRetrievalService,</div><div class="line">      JobGraph jobGraph,</div><div class="line">      FiniteDuration timeout,</div><div class="line">      <span class="keyword">boolean</span> sysoutLogUpdates,</div><div class="line">      ClassLoader classLoader) <span class="keyword">throws</span> JobExecutionException &#123;</div><div class="line"></div><div class="line">   ...</div><div class="line"></div><div class="line">   <span class="comment">// for this job, we create a proxy JobClientActor that deals with all communication with</span></div><div class="line">   <span class="comment">// the JobManager. It forwards the job submission, checks the success/failure responses, logs</span></div><div class="line">   <span class="comment">// update messages, watches for disconnect between client and JobManager, ...</span></div><div class="line"></div><div class="line">   Props jobClientActorProps = JobClientActor.createJobClientActorProps(</div><div class="line">      leaderRetrievalService,</div><div class="line">      timeout,</div><div class="line">      sysoutLogUpdates);</div><div class="line"></div><div class="line">   ActorRef jobClientActor = actorSystem.actorOf(jobClientActorProps);</div><div class="line"></div><div class="line">   <span class="comment">// first block handles errors while waiting for the result</span></div><div class="line">   Object answer;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">      Future&lt;Object&gt; future = Patterns.ask(jobClientActor,</div><div class="line">            <span class="keyword">new</span> JobClientMessages.SubmitJobAndWait(jobGraph),</div><div class="line">            <span class="keyword">new</span> Timeout(AkkaUtils.INF_TIMEOUT()));</div><div class="line"></div><div class="line">      answer = Await.result(future, AkkaUtils.INF_TIMEOUT());</div><div class="line">   &#125;</div><div class="line">   ...</div></pre></td></tr></table></figure>
<p>åœ¨<code>JobClientActor</code>å¯åŠ¨ä¹‹å‰ä¼šå¯åŠ¨<code>LeaderRetrivalService</code>ï¼Œ<code>LeaderRetrivalService</code>å¯åŠ¨ä¹‹åä¼šé€šçŸ¥å®ƒçš„ Listener <code>JobClientActor</code>è·å–<code>JobManager</code>çš„åœ°å€å’Œå½“å‰ session idã€‚ä¹‹åç»è¿‡æ¶ˆæ¯è·¯ç”±è·³è½¬åˆ°æäº¤çš„æ ¸å¿ƒé€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//JobClientActor line354</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">tryToSubmitJob</span><span class="params">(<span class="keyword">final</span> JobGraph jobGraph)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.jobGraph = jobGraph;</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (isConnected()) &#123;</div><div class="line">      LOG.info(<span class="string">"Sending message to JobManager &#123;&#125; to submit job &#123;&#125; (&#123;&#125;) and wait for progress"</span>,</div><div class="line">         jobManager.path().toString(), jobGraph.getName(), jobGraph.getJobID());</div><div class="line"></div><div class="line">      Futures.future(<span class="keyword">new</span> Callable&lt;Object&gt;() &#123;</div><div class="line">         <span class="meta">@Override</span></div><div class="line">         <span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            ActorGateway jobManagerGateway = <span class="keyword">new</span> AkkaActorGateway(jobManager, leaderSessionID);</div><div class="line"></div><div class="line">            LOG.info(<span class="string">"Upload jar files to job manager &#123;&#125;."</span>, jobManager.path());</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">               jobGraph.uploadUserJars(jobManagerGateway, timeout);</div></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç æœ‰æ‰€çœç•¥ğŸ˜ã€‚</p>
<p>æ€»ç»“ä¸‹ä¸Šé¢çš„è¿‡ç¨‹ï¼š</p>
<img src="/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/jobclient-to-jobmanager.png" alt="jobclient-to-jobmanager" title="jobclient-to-jobmanager">
<ul>
<li>å¯åŠ¨<code>JobClientActor</code>ç”¨æ¥å’Œ<code>JobManager</code>äº¤äº’</li>
<li>å¯åŠ¨<code>LeaderRetrievalService</code>è·å–<code>JobManager</code>çš„åœ°å€</li>
<li>ä¸Šä¼ ç”¨æˆ· jar åŒ…</li>
<li>æäº¤ SubmitJob å‘½ä»¤</li>
</ul>
<h2 id="JobManageræ‰§è¡Œè®¡åˆ’ç”Ÿæˆ"><a href="#JobManageræ‰§è¡Œè®¡åˆ’ç”Ÿæˆ" class="headerlink" title="JobManageræ‰§è¡Œè®¡åˆ’ç”Ÿæˆ"></a>JobManageræ‰§è¡Œè®¡åˆ’ç”Ÿæˆ</h2><p><code>JobManager</code>è´Ÿè´£æ¥æ”¶ flink çš„ä½œä¸šï¼Œè°ƒåº¦ taskï¼Œæ”¶é›† job çš„çŠ¶æ€ã€ç®¡ç† TaskManagersã€‚è¢«å®ç°ä¸ºä¸€ä¸ª akka actorã€‚</p>
<p>å®¢æˆ·ç«¯ä¸Šä¼ å®Œ jar åŒ…å’Œ<code>JobGraph</code>ï¼Œflink ä¼šè¿›ä¸€æ­¥è§£æå°è£…æˆè¿è¡Œæ—¶çš„æ‰§è¡Œè®¡åˆ’<code>ExecutionGraph</code>ï¼Œ<code>JobManager</code>çš„æ„é€ å™¨åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥äº†å¾ˆå¤šç»„ä»¶ï¼Œè¿™é‡Œç®€å•åˆ—ä¸¾ä¸‹åŠŸèƒ½æ–¹ä¾¿åé¢çš„é€»è¾‘å±•å¼€ï¼Œå…·ä½“çš„ç»†èŠ‚å°†ä¼šåœ¨ä¸‹ä¸€èŠ‚è®²è§£ã€‚</p>
<ul>
<li><code>BlobServer</code>ï¼šå®ç°äº† BOLB serverï¼Œå…¶ä¼šç›‘å¬æ”¶åˆ°çš„ requestsï¼Œå¹¶ä¼šåˆ›å»º ç›®å½•ç»“æ„å­˜å‚¨ BLOBS ã€æŒä¹…åŒ–ã€‘æˆ–è€…ä¸´æ—¶æ€§çš„ç¼“å­˜ä»–ä»¬</li>
<li><code>InstanceManager</code>ï¼šTaskManageråœ¨<code>flink</code>æ¡†æ¶å†…éƒ¨è¢«å«åš<code>Instance</code>ï¼Œflinké€šè¿‡<code>InstanceManager</code>ç®¡ç† flink é›†ç¾¤ä¸­å½“å‰æ‰€æœ‰æ´»è·ƒçš„ TaskManagerï¼ŒåŒ…æ‹¬æ¥æ”¶å¿ƒè·³ï¼Œé€šçŸ¥ InstanceListener Instance çš„ç”Ÿæˆä¸æ­»äº¡ï¼Œä¸€ä¸ªå…¸å‹çš„ <code>InstanceListener</code> ä¸º flink çš„ Scheduler</li>
<li><code>BlobLibraryCacheManager</code>ï¼šflink job çš„ jar åŒ…å­˜å‚¨æœåŠ¡ï¼Œä½¿ç”¨ä¸Šé¢çš„ BlobServer å®Œæˆã€‚</li>
<li><code>MemoryArchivist</code>å¤‡æ¡ˆå·²æäº¤çš„flinkä½œä¸šï¼ŒåŒ…æ‹¬<code>JobGraph</code>ã€<code>ExecutionGraph</code>ç­‰</li>
<li>â€‹</li>
<li><code>ZooKeeperCompletedCheckpointStore</code>ï¼šè´Ÿè´£æŒä¹…åŒ– job çš„ checkpoint ä¿¡æ¯ï¼Œä¸€ä¸ª job å¯ä»¥æŒä¹…åŒ–å¤šä¸ª checkpointï¼Œä½†åªæœ‰æœ€æ–°çš„ä¼šè¢«ä½¿ç”¨ï¼Œå…·ä½“æ–¹å¼ä¸ºå…ˆåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æŒä¹…åŒ–ä¸€ä»½ï¼Œå†å°†æ–‡ä»¶å¥æŸ„æ›´æ–°åˆ° zkï¼Œå¹¶åœ¨ zkä¸Šä¾æ¬¡é€’å¢èŠ‚ç‚¹è·¯å¾„å·ï¼Œzk ä¸Šä¿å­˜äº†æœ€è¿‘çš„ 10 æ¬¡ checkpoint</li>
<li>SavepointStoreï¼šflink çš„çŠ¶æ€å­˜å‚¨ï¼Œè´Ÿè´£å­˜å‚¨ç®—å­å†…éƒ¨å®šä¹‰çš„çŠ¶æ€ï¼Œä¸ checkpoint ç¨æœ‰åŒºåˆ«ï¼Œåè€…ç”± flink æ¡†æ¶æ¥ç»´æŠ¤</li>
</ul>
<p><em>ä¸ºäº†å¯¹<code>JobManager</code>ä¸­æ‰€èµ·çš„ actors æœåŠ¡æœ‰æ‰€äº†è§£ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹<code>JobManager</code>çš„å¯åŠ¨è¿‡ç¨‹</em></p>
<p>ç®€å•åˆ†æå¾—çŸ¥<code>line2049: runJobManager</code>æ˜¯JobManagerå¯åŠ¨çš„å…¥å£ï¼Œåœ¨è·å–<code>JobManager</code>å¯åŠ¨çš„ä¸»æœºå’Œç«¯å£åï¼Œå˜å¼€å§‹å¯åŠ¨ actor systemï¼Œweb uiä»¥åŠå…¶ä»– actorsï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//JobManager line2008</span></div><div class="line"><span class="function">def <span class="title">runJobManager</span><span class="params">(</span></span></div><div class="line">    configuration: Configuration,</div><div class="line">    executionMode: JobManagerMode,</div><div class="line">    listeningAddress: String,</div><div class="line">    listeningPort: Int)</div><div class="line">  : Unit = &#123;</div><div class="line"></div><div class="line">  val (jobManagerSystem, _, _, webMonitorOption, _) = startActorSystemAndJobManagerActors(</div><div class="line">    configuration,</div><div class="line">    executionMode,</div><div class="line">    listeningAddress,</div><div class="line">    listeningPort,</div><div class="line">    classOf[JobManager],</div><div class="line">    classOf[MemoryArchivist],</div><div class="line">    Option(classOf[StandaloneResourceManager])</div><div class="line">  )</div><div class="line"></div><div class="line">  <span class="comment">// block until everything is shut down</span></div><div class="line">  jobManagerSystem.awaitTermination()</div></pre></td></tr></table></figure>
<p>å…·ä½“çš„å¯åŠ¨é€»è¾‘åœ¨<code>startActorSystemAndJobManagerActors</code>æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//JobManager line2150</span></div><div class="line"><span class="function">def <span class="title">startActorSystemAndJobManagerActors</span><span class="params">(</span></span></div><div class="line">    configuration: Configuration,</div><div class="line">    executionMode: JobManagerMode,</div><div class="line">    listeningAddress: String,</div><div class="line">    listeningPort: Int,</div><div class="line">    jobManagerClass: Class[_ &lt;: JobManager],</div><div class="line">    archiveClass: Class[_ &lt;: MemoryArchivist],</div><div class="line">    resourceManagerClass: Option[Class[_ &lt;: FlinkResourceManager[_]]])</div><div class="line">  : <span class="params">(ActorSystem, ActorRef, ActorRef, Option[WebMonitor], Option[ActorRef])</span> = &#123;</div><div class="line">  ...</div></pre></td></tr></table></figure>
<p>ç®€å•åˆ—ä¸¾ä¸‹é€»è¾‘ï¼š</p>
<ul>
<li>JobManager ç¨‹åºçš„ä¸»å…¥å£ï¼Œç”± ApplicationMasterBase å‘èµ·</li>
<li>line 2174 ä½¿ç”¨ Json é…ç½® Akka å¹¶ç”Ÿæˆ ActorSystem</li>
<li>line 2197 åˆå§‹åŒ– ZooKeeperLeaderRetrievalServiceï¼ŒJobManageråœ¨å¯åŠ¨çš„æ—¶å€™ä¼šä»¥ LeaderRetrievalListener çš„èº«ä»½å°†è‡ªå·±æ³¨å†Œè¿›æ¥ï¼Œè¯¥ service è´Ÿè´£ç›‘å¬æœ€æ–°çš„ leader ä¿¡æ¯ï¼Œå½“å‘ç”Ÿæ”¹å˜æ—¶ é€šçŸ¥æ‰€æœ‰ listenerã€æ‰€æœ‰çš„ JobManagerã€‘</li>
<li>line 2220 å¯åŠ¨ YarnJobManager å’Œ MemoryArchivist actorsã€è¿™é‡Œå¹¶æ²¡æœ‰å¯åŠ¨ã€‘</li>
<li>line2268 å¯åŠ¨ã€flinkåŸºæœ¬ç»„ä»¶å’ŒJobGraphçš„ç”Ÿæˆä¸€èŠ‚ä¸­æåˆ°çš„ã€‘FlinkResourceManager</li>
<li>line 2620 createJobManagerComponents è·å–ä»¥ä¸Šä¸¤ä¸ªç»„ä»¶å¿…è¦çš„é…ç½®ï¼Œå¹¶åˆå§‹åŒ–ç›¸å…³æœåŠ¡ å…·ä½“è§ã€ flink JobManager ä¸­æ‰€èµ·çš„æœåŠ¡ã€‘è¿™é‡Œåœ¨åˆå§‹åŒ–ç›¸å…³ç»„ä»¶åä¼šåˆå§‹åŒ– JobManagerï¼Œakka actorOf æ–¹æ³•ä¼ å…¥çš„å±æ€§ä¸ºæ„é€ å™¨ä¸­å‚æ•°ï¼Œé‡è½½ preStart å’Œ postStop æ–¹æ³•ä¼šåœ¨ actor å¯åŠ¨å’Œå…³é—­å ç›¸ç»§æ‰§è¡Œï¼ŒJobManager ä¼šåœ¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¸­å¯åŠ¨å’Œåœæ­¢è¿™äº›æœåŠ¡</li>
</ul>
<p>åˆ°è¿™é‡Œä¸€ä¸ªå®Œæ•´çš„<code>JobManager</code> actor ä¾¿å¯åŠ¨èµ·æ¥äº†ğŸ˜œ</p>
<p>æ—¢ç„¶æ˜¯ actor ï¼Œé‚£ä¹ˆä»–çš„æ ¸å¿ƒé€»è¾‘ä¸€å®šæ˜¯å„ç§æ¶ˆæ¯çš„è·¯ç”±å’Œå¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//JobManager line304</span></div><div class="line">override def handleMessage: Receive = &#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">case</span> <span class="title">GrantLeadership</span><span class="params">(newLeaderSessionID)</span> </span>=&gt;</div><div class="line">    log.info(s<span class="string">"JobManager $getAddress was granted leadership with leader session ID "</span> +</div><div class="line">      s<span class="string">"$newLeaderSessionID."</span>)</div><div class="line"></div><div class="line">    leaderSessionID = newLeaderSessionID</div></pre></td></tr></table></figure>
<p>ä»‹ç»ä¸‹è¿™é‡Œæ¯”è¾ƒé‡è¦çš„å‡ ç§æ¶ˆæ¯ï¼š</p>
<ul>
<li>å¤„ç†æ¶ˆæ¯çš„æ ¸å¿ƒæ–¹æ³•</li>
<li>GrantLeadership è·å¾—leaderæˆæƒï¼Œå°†è‡ªèº«è¢«åˆ†å‘åˆ°çš„ session id å†™åˆ° zookeeperï¼Œå¹¶æ¢å¤æ‰€æœ‰çš„ jobs.</li>
<li>RevokeLeadership å‰¥å¤ºleaderæˆæƒï¼Œæ‰“æ–­æ¸…ç©ºæ‰€æœ‰çš„ job ä¿¡æ¯ï¼Œä½†æ˜¯ä¿ç•™ä½œä¸šç¼“å­˜ï¼Œæ³¨é”€æ‰€æœ‰çš„ TaskManagers. </li>
<li>RegisterTaskManagers æ³¨å†Œ TaskManagerï¼Œå¦‚æœä¹‹å‰å·²ç»æ³¨å†Œè¿‡ï¼Œåˆ™åªç»™å¯¹åº”çš„ Instance å‘é€æ¶ˆæ¯ï¼Œå¦åˆ™å¯åŠ¨æ³¨å†Œé€»è¾‘ï¼šåœ¨ InstanceManager ä¸­æ³¨å†Œè¯¥ Instance çš„ä¿¡æ¯ï¼Œå¹¶åœæ­¢ Instance BlobLibraryCacheManager çš„ç«¯å£ã€ä¾›ä¸‹è½½ lib åŒ…ç”¨ã€‘ï¼ŒåŒæ—¶ä½¿ç”¨ watch ç›‘å¬ task manager çš„å­˜æ´»</li>
<li>SubmitJob æäº¤ jobGraph</li>
</ul>
<h3 id="æ‰§è¡Œè®¡åˆ’-ExecutionGraph-çš„ç”Ÿæˆ"><a href="#æ‰§è¡Œè®¡åˆ’-ExecutionGraph-çš„ç”Ÿæˆ" class="headerlink" title="æ‰§è¡Œè®¡åˆ’ ExecutionGraph çš„ç”Ÿæˆ"></a>æ‰§è¡Œè®¡åˆ’ ExecutionGraph çš„ç”Ÿæˆ</h3><p>flink çš„è¿è¡Œæ—¶æ‰§è¡Œè®¡åˆ’ä¸º ExecutionGraphï¼ŒExecutionGraph å¯¹åº”ä¹‹å‰çš„ JobGraphï¼Œä¸€ä¸ª ExecutionGraph åŒ…å«å¤šä¸ª ExecutionJobVertex èŠ‚ç‚¹ï¼ŒJobGraph çš„ JobVertexï¼Œæ¯ä¸ª ExecutionJobVertex èŠ‚ç‚¹çš„å¹¶å‘å­ task å¯¹åº”ä¸€ä¸ª ExecutionVertexï¼Œæ¯ä¸ª ExecutionVertex çš„ä¸€æ¬¡ attempt æ‰§è¡Œè¢«æŠ½è±¡ä¸ºä¸€æ¬¡ Executionï¼Œå…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/flink-job-vertex-to-execution.png" alt="flink-job-vertex-to-execution.png" title="flink-job-vertex-to-execution.png">
<p><em>ä¸‹é¢ä¼šå¯¹æ¯ä¸ªæŠ½è±¡åšè¯¦ç»†çš„ä»‹ç»</em></p>
<p>ExecutionGraph çš„åˆ›å»ºæ˜¯åœ¨ JobManager æ¥æ”¶ SubmitJob å‘½ä»¤åå¼€å§‹çš„ï¼Œè¿™æ¡æ¶ˆæ¯ä¼šè¢«è·¯ç”±åˆ°æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//JobManager line1048</span></div><div class="line"><span class="function"><span class="keyword">private</span> def <span class="title">submitJob</span><span class="params">(jobGraph: JobGraph, jobInfo: JobInfo, isRecovery: Boolean = <span class="keyword">false</span>)</span>: Unit </span>= &#123;</div><div class="line">  <span class="keyword">if</span> (jobGraph == <span class="keyword">null</span>) &#123;</div><div class="line">    jobInfo.client ! decorateMessage(JobResultFailure(</div><div class="line">      <span class="keyword">new</span> SerializedThrowable(</div><div class="line">        <span class="keyword">new</span> JobSubmissionException(<span class="keyword">null</span>, <span class="string">"JobGraph must not be null."</span>)</div><div class="line">      )</div><div class="line">    ))</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>å…¶é€»è¾‘æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>æäº¤ä½œä¸š</li>
<li>å…·ä½“çš„ç»„ä»¶äº¤äº’è¿‡ç¨‹ Client.java line169 runBlocking -&gt; JobClient.java line102 submitJobAndWait -&gt; JobClientActor.java line 337 tryToSubmitJob  è¿™é‡Œä¼šå…ˆä¸Šä¼  jars åˆ° JobManager çš„ BlobServerï¼Œç„¶åå‘èµ·æäº¤å‘½ä»¤</li>
<li>line1068: è®¾ç½®ç”¨æˆ·libåŒ…ï¼Œä½¿ç”¨  LibraryCacheManager book job çš„jaråŒ…ï¼Œç”±äºä¹‹å‰åŒ…å·²ä¸Šä¼ ï¼Œè¿™ä¼šåˆ›å»ºjobId å’Œ jars ä»¥åŠclass paths çš„å¯¹åº”å…³ç³»</li>
<li>line1114: å°† JobGraph è½¬æ¢ä¸º ExecutionGraph é€»è¾‘è®¡åˆ’è½¬åŒ–ä¸ºç‰©ç†è®¡åˆ’ã€åè€…ç»´æŠ¤ data flow çš„åè°ƒæ‰§è¡Œã€è¿æ¥ã€è®¡ç®—ä¸­é—´ç»“æœã€‘å…·ä½“è§ç« èŠ‚ï¼š flink runtime</li>
<li>line 1178 ExecutionJobVertex åœ¨æ­¤å¤„ç”Ÿæˆï¼Œé€šè¿‡ JobGraph ä¾ç…§æ•°æ®æºé¡ºåºè·å–ä¸‹æ¸¸ JobVertexï¼Œå…·ä½“ç®—æ³•å¦‚ä¸‹ï¼š</li>
</ul>
<img src="/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/job-graph-node-sort.png" alt="job-graph-node-sort.png" title="job-graph-node-sort.png">
<p>flinkæ’åºèŠ‚ç‚¹çš„é¡ºåºï¼š</p>
<ul>
<li>æ•°æ®æºèŠ‚ç‚¹</li>
<li>åªæœ‰ä¸€ä¸ªä¸Šæ¸¸çš„èŠ‚ç‚¹</li>
<li>sinkèŠ‚ç‚¹</li>
</ul>
<p><em>ä¾‹å¦‚ä¸Šå›¾çš„ä¸¤ä¸ªæ‹“æ‰‘ç»“æ„ï¼Œå·¦è¾¹èŠ‚ç‚¹æ’åºå®Œçš„é¡ºåºä¸ºï¼š 1 2 3 4 5 å³è¾¹çš„èŠ‚ç‚¹æ’åºå®Œçš„é¡ºåºä¸ºï¼š1 2 3 5 4 6</em></p>
<p>é‚£ä¹ˆ flink ä¸ºä»€ä¹ˆè¦å°† JobGraph è½¬æ¢ä¸º ExecutionGraph ï¼Œå¹¶ä¸”æ’åºè¿™äº›èŠ‚ç‚¹å‘¢ï¼ŸExecutionGraph ä»£è¡¨äº†è¿è¡Œæ—¶çš„æ‰§è¡Œè®¡åˆ’ï¼ŒåŒ…æ‹¬ task çš„å¹¶å‘ã€è¿æ¥ã€ä¸­é—´ç»“æœçš„ç»´æŠ¤ç­‰ï¼Œæ’åºçš„ç›®çš„æ˜¯ç»™ task çš„éƒ¨ç½²è®¾ç½®å…ˆåé¡ºåºï¼Œæƒ³æ¥ä¹Ÿæ˜¯å¾ˆè‡ªç„¶çš„ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ ExecutionGraph çš„æ„é€ å™¨å°±èƒ½äº†è§£ä¸ªå¤§æ¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ExecutionGraph</span><span class="params">(</span></span></div><div class="line">      ExecutionContext executionContext,</div><div class="line">      JobID jobId,</div><div class="line">      String jobName,</div><div class="line">      Configuration jobConfig,</div><div class="line">      SerializedValue&lt;ExecutionConfig&gt; serializedConfig,</div><div class="line">      FiniteDuration timeout,</div><div class="line">      RestartStrategy restartStrategy,</div><div class="line">      List&lt;BlobKey&gt; requiredJarFiles,</div><div class="line">      List&lt;URL&gt; requiredClasspaths,</div><div class="line">      ClassLoader userClassLoader,</div><div class="line">      MetricGroup metricGroup) &#123;</div><div class="line"></div><div class="line">   ...</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.executionContext = executionContext;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.jobID = jobId;</div><div class="line">   <span class="keyword">this</span>.jobName = jobName;</div><div class="line">   <span class="keyword">this</span>.jobConfiguration = jobConfig;</div><div class="line">   <span class="keyword">this</span>.userClassLoader = userClassLoader;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.tasks = <span class="keyword">new</span> ConcurrentHashMap&lt;JobVertexID, ExecutionJobVertex&gt;();</div><div class="line">   <span class="keyword">this</span>.intermediateResults = <span class="keyword">new</span> ConcurrentHashMap&lt;IntermediateDataSetID, IntermediateResult&gt;();</div><div class="line">   <span class="keyword">this</span>.verticesInCreationOrder = <span class="keyword">new</span> ArrayList&lt;ExecutionJobVertex&gt;();</div><div class="line">   <span class="keyword">this</span>.currentExecutions = <span class="keyword">new</span> ConcurrentHashMap&lt;ExecutionAttemptID, Execution&gt;();</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.jobStatusListenerActors  = <span class="keyword">new</span> CopyOnWriteArrayList&lt;ActorGateway&gt;();</div><div class="line">   <span class="keyword">this</span>.executionListenerActors = <span class="keyword">new</span> CopyOnWriteArrayList&lt;ActorGateway&gt;();</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.stateTimestamps = <span class="keyword">new</span> <span class="keyword">long</span>[JobStatus.values().length];</div><div class="line">   <span class="keyword">this</span>.stateTimestamps[JobStatus.CREATED.ordinal()] = System.currentTimeMillis();</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.requiredJarFiles = requiredJarFiles;</div><div class="line">   <span class="keyword">this</span>.requiredClasspaths = requiredClasspaths;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.serializedExecutionConfig = checkNotNull(serializedConfig);</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.timeout = timeout;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.restartStrategy = restartStrategy;</div><div class="line"></div><div class="line">   metricGroup.gauge(RESTARTING_TIME_METRIC_NAME, <span class="keyword">new</span> RestartTimeGauge());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»æ„é€ å™¨å¯ä»¥çœ‹å‡ºï¼ŒExecutionGraph ä¼šç»´æŠ¤å½“å‰çš„é€»è¾‘è®¡åˆ’ä¿¡æ¯ã€å°±æ˜¯æœ‰å“ªäº›taskè¦æ‰§è¡Œã€‘ã€ä¸­é—´ç»“æœç”Ÿæˆä¿¡æ¯ï¼Œå½“å‰æ­£åœ¨è¿è¡Œçš„ taskï¼Œè´Ÿè´£ job å’Œ task çŠ¶æ€åˆ‡æ¢çš„é€šçŸ¥ç­‰ã€‚</p>
<h4 id="æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹-ExecutionJobVertex-çš„ç”Ÿæˆ"><a href="#æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹-ExecutionJobVertex-çš„ç”Ÿæˆ" class="headerlink" title="æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ ExecutionJobVertex çš„ç”Ÿæˆ"></a>æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ ExecutionJobVertex çš„ç”Ÿæˆ</h4><p>attachJobGraph æ˜¯ ExecutionGraph æ„é€ å›¾ç»“æ„çš„æ ¸å¿ƒæ–¹æ³•ï¼Œè€Œå…¶ä¸­æœ€å…³é”®çš„é€»è¾‘æ˜¯ æ‰§è¡ŒèŠ‚ç‚¹ ExecutionJobGraph çš„åˆ›å»ºï¼Œä¸‹é¢è¯¦ç»†åˆ†æä¸‹å…¶åˆ›å»ºè¿‡ç¨‹å’Œæ ¸å¿ƒåŠŸèƒ½ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ExecutionJobVertex line95</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ExecutionJobVertex</span><span class="params">(ExecutionGraph graph, JobVertex jobVertex,</span></span></div><div class="line">                  <span class="keyword">int</span> defaultParallelism, FiniteDuration timeout, <span class="keyword">long</span> createTimestamp)</div><div class="line">      <span class="keyword">throws</span> JobException</div><div class="line">&#123;</div><div class="line">   ...</div><div class="line">   <span class="keyword">this</span>.graph = graph;</div><div class="line">   <span class="keyword">this</span>.jobVertex = jobVertex;</div><div class="line"></div><div class="line">   <span class="keyword">int</span> vertexParallelism = jobVertex.getParallelism();</div><div class="line">   <span class="keyword">int</span> numTaskVertices = vertexParallelism &gt; <span class="number">0</span> ? vertexParallelism : defaultParallelism;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.parallelism = numTaskVertices;</div><div class="line">   <span class="keyword">this</span>.taskVertices = <span class="keyword">new</span> ExecutionVertex[numTaskVertices];</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.inputs = <span class="keyword">new</span> ArrayList&lt;IntermediateResult&gt;(jobVertex.getInputs().size());</div><div class="line"></div><div class="line">   <span class="comment">// take the sharing group</span></div><div class="line">   <span class="keyword">this</span>.slotSharingGroup = jobVertex.getSlotSharingGroup();</div><div class="line">   <span class="keyword">this</span>.coLocationGroup = jobVertex.getCoLocationGroup();</div><div class="line">   ...</div><div class="line"></div><div class="line">   <span class="comment">// create the intermediate results</span></div><div class="line">   <span class="keyword">this</span>.producedDataSets = <span class="keyword">new</span> IntermediateResult[jobVertex.getNumberOfProducedIntermediateDataSets()];</div><div class="line"></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jobVertex.getProducedDataSets().size(); i++) &#123;</div><div class="line">      <span class="keyword">final</span> IntermediateDataSet result = jobVertex.getProducedDataSets().get(i);</div><div class="line"></div><div class="line">      <span class="keyword">this</span>.producedDataSets[i] = <span class="keyword">new</span> IntermediateResult(</div><div class="line">            result.getId(),</div><div class="line">            <span class="keyword">this</span>,</div><div class="line">            numTaskVertices,</div><div class="line">            result.getResultType(),</div><div class="line">            result.getEagerlyDeployConsumers());</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// create all task vertices</span></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numTaskVertices; i++) &#123;</div><div class="line">      ExecutionVertex vertex = <span class="keyword">new</span> ExecutionVertex(<span class="keyword">this</span>, i, <span class="keyword">this</span>.producedDataSets, timeout, createTimestamp);</div><div class="line">      <span class="keyword">this</span>.taskVertices[i] = vertex;</div><div class="line">   &#125;</div><div class="line">   ...</div><div class="line"></div><div class="line">   <span class="comment">// set up the input splits, if the vertex has any</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">      <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">      InputSplitSource&lt;InputSplit&gt; splitSource = (InputSplitSource&lt;InputSplit&gt;) jobVertex.getInputSplitSource();</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (splitSource != <span class="keyword">null</span>) &#123;</div><div class="line">         inputSplits = splitSource.createInputSplits(numTaskVertices);</div><div class="line"></div><div class="line">         <span class="keyword">if</span> (inputSplits != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (splitSource <span class="keyword">instanceof</span> StrictlyLocalAssignment) &#123;</div><div class="line">               inputSplitsPerSubtask = computeLocalInputSplitsPerTask(inputSplits);</div><div class="line">               splitAssigner = <span class="keyword">new</span> PredeterminedInputSplitAssigner(inputSplitsPerSubtask);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">               splitAssigner = splitSource.getInputSplitAssigner(inputSplits);</div><div class="line">            &#125;</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> &#123;</div><div class="line">         inputSplits = <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JobException(<span class="string">"Creating the input splits caused an error: "</span> + t.getMessage(), t);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   finishedSubtasks = <span class="keyword">new</span> <span class="keyword">boolean</span>[parallelism];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç®€è¦ä»‹ç»ä¸‹å…¶æ„å»ºé€»è¾‘ï¼š</p>
<ul>
<li>ä¾æ®å¯¹åº”çš„ JobVetex çš„å¹¶å‘ç”Ÿæˆå¯¹åº”ä¸ªæ•°çš„ ExecutionVertexï¼Œä¸€ä¸ª ExecutionVertex ä»£è¡¨ä¸€ä¸ª ExecutionJobVertex çš„å¹¶å‘å­ task</li>
<li>è®¾ç½® SlotSharingGroup å’Œ CoLocationGroupï¼Œè¿™ä¸¤ä¸ªç»„ä»¶æ˜¯ flink è¿è¡Œæ—¶ä»»åŠ¡è°ƒåº¦çš„æ ¸å¿ƒæŠ½è±¡ï¼Œä¼šçº¦æŸ flink è°ƒåº¦ task çš„ç­–ç•¥ï¼Œåœ¨ flink ä»»åŠ¡è°ƒåº¦ç®—æ³• ä¸€èŠ‚ä¼šè¯¦ç»†ä»‹ç»</li>
<li>å°†åŸæ¥ JobVertex çš„ä¸­é—´ç»“æœ IntermediateDataSet è½¬åŒ–ä¸º IntermediateResultï¼Œåè€…åœ¨å‰è€…çš„åŸºç¡€ä¸ŠåŠ å…¥äº† å½“å‰æ­£åœ¨è¿è¡Œçš„ producer ä¿¡æ¯ï¼Œæ˜¯çœŸæ­£å…³äºè¿è¡Œæ—¶ä¸­é—´æ•°æ®çš„æŠ½è±¡</li>
<li>å¦‚æœå¯¹åº”çš„ job èŠ‚ç‚¹æ˜¯æ•°æ®æºèŠ‚ç‚¹ï¼Œä¼šè·å–å…¶ InputSplitSourceï¼ŒInputSplitSource æ§åˆ¶äº†æ•°æ®æºå¹¶å‘å­ task å’Œç”Ÿäº§çš„ InputSplit çš„å¯¹åº”å…³ç³»ï¼Œä¸€ä¸ª InputSplit ä»£è¡¨ä¸€ä¸ªæ•°æ®æºåˆ†ç‰‡ï¼Œå¯¹äº flink streaming æ¥è¯´ï¼ŒInputSplitSource å°±æ˜¯ä¸€ä¸ª InputFormatï¼Œå¯¹åº”ä¸€ä¸ªè¾“å…¥æº task</li>
<li>è¿™é‡Œçš„ InputSplitSource æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è®¾ç½®è¿›å»çš„å‘¢ï¼Ÿè§<code>JobManager line1163 vertex.initializeOnMaster(userCodeLoader)</code>ä»¥åŠ<code>StreamingJobGraphGenerator.java line 278 createDataSourceVertex</code></li>
</ul>
<h4 id="æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹-ExecutionJobVertex-çš„è¿æ¥"><a href="#æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹-ExecutionJobVertex-çš„è¿æ¥" class="headerlink" title="æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ ExecutionJobVertex çš„è¿æ¥"></a>æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ ExecutionJobVertex çš„è¿æ¥</h4><p>æ„å»ºå®ŒèŠ‚ç‚¹åé€šè¿‡è¿æ¥ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ DAGã€è§ExecutionGraph attachJobGraph æ–¹æ³•ã€‘ï¼ŒconnectToPredecessors æ˜¯è¿æ¥æ‰§è¡ŒèŠ‚ç‚¹çš„æ ¸å¿ƒé€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ExecutionJobGraph line237</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectToPredecessors</span><span class="params">(Map&lt;IntermediateDataSetID, IntermediateResult&gt; intermediateDataSets)</span> <span class="keyword">throws</span> JobException </span>&#123;</div><div class="line"></div><div class="line">   List&lt;JobEdge&gt; inputs = jobVertex.getInputs();</div><div class="line"></div><div class="line">   ...</div><div class="line"></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> num = <span class="number">0</span>; num &lt; inputs.size(); num++) &#123;</div><div class="line">      JobEdge edge = inputs.get(num);</div><div class="line"></div><div class="line">      ...</div><div class="line"></div><div class="line">      <span class="comment">// fetch the intermediate result via ID. if it does not exist, then it either has not been created, or the order</span></div><div class="line">      <span class="comment">// in which this method is called for the job vertices is not a topological order</span></div><div class="line">      IntermediateResult ires = intermediateDataSets.get(edge.getSourceId());</div><div class="line">      <span class="keyword">if</span> (ires == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> JobException(<span class="string">"Cannot connect this job graph to the previous graph. No previous intermediate result found for ID "</span></div><div class="line">               + edge.getSourceId());</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">this</span>.inputs.add(ires);</div><div class="line"></div><div class="line">      <span class="keyword">int</span> consumerIndex = ires.registerConsumer();</div><div class="line"></div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parallelism; i++) &#123;</div><div class="line">         ExecutionVertex ev = taskVertices[i];</div><div class="line">         ev.connectSource(num, ires, edge, consumerIndex);</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç®€è¦æ¦‚æ‹¬é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li>è®¾ç½®è¾“å…¥ IntermediateResult</li>
<li>å°†è‡ªå·±æ³¨å†Œåˆ°  IntermediateResultï¼Œç›®å‰ä¸€ä¸ª IntermediateResult åªæ”¯æŒä¸€ä¸ª æ¶ˆè´¹ ExecutionJobVertex èŠ‚ç‚¹</li>
<li>è®¾ç½®å¹¶å‘å­ task ExecutionVertex å’Œä¸­é—´ç»“æœ IntermediateResult çš„è¿æ¥å…³ç³»ï¼Œé€šè¿‡ ExecutionVertex çš„ connectSource  æ–¹æ³•è®¾ç½® ExecutionVertex çš„è¿æ¥ç­–ç•¥ï¼Œç­–ç•¥ä¸€å…±ä¸¤ç§ï¼š POINT_WISE ALL_TO_ALL å‰è€…ä¸Šæ¸¸ partition ä¸ä¸‹æ¸¸ consumers ä¹‹é—´æ˜¯ä¸€å¯¹å¤šå…³ç³»ï¼Œåè€…æ˜¯ all to all å…³ç³»ï¼Œè¿™é‡Œä¼šå°† ExecutionEdge åˆ›å»ºå‡ºæ¥å¹¶æ·»åŠ  consumer ä¸ºæ­¤ edgeã€partitionåœ¨ new ExecutionVertexæ—¶åˆ›å»ºå‡ºæ¥ï¼Œç”± ExecutionVertex æ„é€ å™¨å¯çŸ¥ä¸€ä¸ª ExecutionVertex ç”Ÿäº§ä¸€ä¸ª partitionï¼Œpartition number å°±æ˜¯ sub task indexã€‘</li>
</ul>
<h4 id="æ‰§è¡ŒèŠ‚ç‚¹å­ä»»åŠ¡-ExecutionVertex"><a href="#æ‰§è¡ŒèŠ‚ç‚¹å­ä»»åŠ¡-ExecutionVertex" class="headerlink" title="æ‰§è¡ŒèŠ‚ç‚¹å­ä»»åŠ¡ ExecutionVertex"></a>æ‰§è¡ŒèŠ‚ç‚¹å­ä»»åŠ¡ ExecutionVertex</h4><p>å…ˆçœ‹ä¸€ä¸‹ ExecutionVertex çš„åˆ›å»ºè¿‡ç¨‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ExecutionVertex</span><span class="params">(</span></span></div><div class="line">      ExecutionJobVertex jobVertex,</div><div class="line">      <span class="keyword">int</span> subTaskIndex,</div><div class="line">      IntermediateResult[] producedDataSets,</div><div class="line">      FiniteDuration timeout,</div><div class="line">      <span class="keyword">long</span> createTimestamp) &#123;</div><div class="line">   <span class="keyword">this</span>.jobVertex = jobVertex;</div><div class="line">   <span class="keyword">this</span>.subTaskIndex = subTaskIndex;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.resultPartitions = <span class="keyword">new</span> LinkedHashMap&lt;IntermediateResultPartitionID, IntermediateResultPartition&gt;(producedDataSets.length, <span class="number">1</span>);</div><div class="line"></div><div class="line">   <span class="keyword">for</span> (IntermediateResult result : producedDataSets) &#123;</div><div class="line">      IntermediateResultPartition irp = <span class="keyword">new</span> IntermediateResultPartition(result, <span class="keyword">this</span>, subTaskIndex);</div><div class="line">      result.setPartition(subTaskIndex, irp);</div><div class="line"></div><div class="line">      resultPartitions.put(irp.getPartitionId(), irp);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.inputEdges = <span class="keyword">new</span> ExecutionEdge[jobVertex.getJobVertex().getInputs().size()][];</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.priorExecutions = <span class="keyword">new</span> CopyOnWriteArrayList&lt;Execution&gt;();</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.currentExecution = <span class="keyword">new</span> Execution(</div><div class="line">      getExecutionGraph().getExecutionContext(),</div><div class="line">      <span class="keyword">this</span>,</div><div class="line">      <span class="number">0</span>,</div><div class="line">      createTimestamp,</div><div class="line">      timeout);</div><div class="line"></div><div class="line">   <span class="comment">// create a co-location scheduling hint, if necessary</span></div><div class="line">   CoLocationGroup clg = jobVertex.getCoLocationGroup();</div><div class="line">   <span class="keyword">if</span> (clg != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">this</span>.locationConstraint = clg.getLocationConstraint(subTaskIndex);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">this</span>.locationConstraint = <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.timeout = timeout;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€»è¾‘æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¾æ®å¯¹åº”çš„ ExecutionJobGraph ç”Ÿæˆçš„ä¸­é—´æ•°æ®é›† IntermediateResult çš„ä¸ªæ•°ç”Ÿæˆä¸€å®šä¸ªæ•°çš„ partitionï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ª IntermediateResult è¾“å‡ºä¸€ä¸ª partition</li>
<li>ç”Ÿæˆ Execution</li>
<li>é…ç½®èµ„æºç›¸å…³</li>
</ul>
<p>ä¸‹é¢é‡ç‚¹ä»‹ç»ä¸‹å…¶è¿æ¥ä¸Šæ¸¸ ExecutionVertex çš„è¿‡ç¨‹ï¼š</p>
<p>connectSource æ˜¯è¿æ¥çš„æ ¸å¿ƒé€»è¾‘ï¼Œé€»è¾‘å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ExecutionVertex line250</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectSource</span><span class="params">(<span class="keyword">int</span> inputNumber, IntermediateResult source, JobEdge edge, <span class="keyword">int</span> consumerNumber)</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="keyword">final</span> DistributionPattern pattern = edge.getDistributionPattern();</div><div class="line">   <span class="keyword">final</span> IntermediateResultPartition[] sourcePartitions = source.getPartitions();</div><div class="line"></div><div class="line">   ExecutionEdge[] edges;</div><div class="line"></div><div class="line">   <span class="keyword">switch</span> (pattern) &#123;</div><div class="line">      <span class="keyword">case</span> POINTWISE:</div><div class="line">         edges = connectPointwise(sourcePartitions, inputNumber);</div><div class="line">         <span class="keyword">break</span>;</div><div class="line"></div><div class="line">      <span class="keyword">case</span> ALL_TO_ALL:</div><div class="line">         edges = connectAllToAll(sourcePartitions, inputNumber);</div><div class="line">         <span class="keyword">break</span>;</div><div class="line"></div><div class="line">      <span class="keyword">default</span>:</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unrecognized distribution pattern."</span>);</div><div class="line"></div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.inputEdges[inputNumber] = edges;</div><div class="line"></div><div class="line">   <span class="comment">// add the consumers to the source</span></div><div class="line">   <span class="comment">// for now (until the receiver initiated handshake is in place), we need to register the</span></div><div class="line">   <span class="comment">// edges as the execution graph</span></div><div class="line">   <span class="keyword">for</span> (ExecutionEdge ee : edges) &#123;</div><div class="line">      ee.getSource().addConsumer(ee, consumerNumber);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€»è¾‘æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>è·å– JobEdge çš„æ•°æ®åˆ†å‘ç­–ç•¥ï¼šå¦‚æœé shuffle æ“ä½œå°±æ˜¯ DistributionPattern.POINTWISE å¦åˆ™æ˜¯ DistributionPattern.ALL_TO_ALLå…·ä½“è§ä»£ç ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//StreamingJobGraphGenerator line370</span></div><div class="line">StreamPartitioner&lt;?&gt; partitioner = edge.getPartitioner();</div><div class="line"><span class="keyword">if</span> (partitioner <span class="keyword">instanceof</span> ForwardPartitioner) &#123;</div><div class="line">   downStreamVertex.connectNewDataSetAsInput(</div><div class="line">      headVertex,</div><div class="line">      DistributionPattern.POINTWISE,</div><div class="line">      ResultPartitionType.PIPELINED,</div><div class="line">      <span class="keyword">true</span>);</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (partitioner <span class="keyword">instanceof</span> RescalePartitioner)&#123;</div><div class="line">   downStreamVertex.connectNewDataSetAsInput(</div><div class="line">      headVertex,</div><div class="line">      DistributionPattern.POINTWISE,</div><div class="line">      ResultPartitionType.PIPELINED,</div><div class="line">      <span class="keyword">true</span>);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">   downStreamVertex.connectNewDataSetAsInput(</div><div class="line">         headVertex,</div><div class="line">         DistributionPattern.ALL_TO_ALL,</div><div class="line">         ResultPartitionType.PIPELINED,</div><div class="line">         <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æŒ‰ç…§ä¸åŒçš„åˆ†å‘ç­–ç•¥è¿æ¥ä¸Šæ¸¸</li>
</ul>
<p>DistributionPattern.ALL_TO_ALL å°±æ˜¯ç®€å•çš„å…¨è¿æ¥ï¼Œè¿™é‡Œå°±ä¸ä»‹ç»äº†ï¼Œåªä»‹ç»DistributionPattern.POINTWISE ç­–ç•¥ã€‚</p>
<p>è¯¥ç­–ç•¥è¿æ¥ execution vertex ä¸ä¸Šæ¸¸çš„ partitionsï¼Œä¼šå…ˆè·å–ä¸Šæ¸¸çš„ partition æ•°ä¸ æ­¤ ExecutionJobVertex çš„å¹¶å‘åº¦ï¼Œå¦‚æœä¸¤è€…å¹¶å‘åº¦ç›¸ç­‰ï¼Œåˆ™æ˜¯ ä¸€å¯¹ä¸€ è¿æ¥ï¼š</p>
<img src="/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/execution-vertex-one-to-one.png" alt="execution-vertex-one-to-one.png" title="execution-vertex-one-to-one.png">
<p>å¦‚æœ partition æ•°å°äº å¹¶å‘æ•° ï¼Œå­ task åªä¼šè¿æ¥ä¸€ä¸ªä¸Šæ¸¸ partitionï¼Œå…·ä½“å…³ç³»å¦‚ä¸‹å›¾ï¼š</p>
<img src="/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/execution-one-many.png" alt="execution-one-many.png" title="execution-one-many.png">
<p>å¦‚æœ partition æ•°å¤§äºå¹¶å‘æ•°ï¼Œå­ task ä¼šè¿æ¥å¤šä¸ªä¸Šæ¸¸ partitionï¼Œå…·ä½“è§ä¸‹å›¾ï¼š</p>
<p>execution-many-one.png](execution-many-one.png)</p>
<p>åˆ°è¿™é‡Œè¿è¡Œæ—¶æ‰§è¡Œè®¡åˆ’ ExecutionGraph çš„ç”Ÿæˆå°±ä»‹ç»å®Œäº†ğŸ˜„ä¸‹èŠ‚å°†å…ˆä»‹ç» JobManager çš„æ ¸å¿ƒç»„ä»¶</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Flink/" rel="tag"># -Flink</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/12/03/FlinkåŸºæœ¬ç»„ä»¶å’Œé€»è¾‘è®¡åˆ’/" rel="next" title="flik åŸºæœ¬ç»„ä»¶å’Œé€»è¾‘è®¡åˆ’">
                <i class="fa fa-chevron-left"></i> flik åŸºæœ¬ç»„ä»¶å’Œé€»è¾‘è®¡åˆ’
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="chenyuzhao" />
          <p class="site-author-name" itemprop="name">chenyuzhao</p>
          <p class="site-description motion-element" itemprop="description">æœ¬äººå–œå¥½æºç é˜…è¯»ï¼Œå¾—ç›Šäºç›®å‰çš„å·¥ä½œç¯å¢ƒï¼Œå¯¹æµå¼è®¡ç®—ä¸»æµçš„æ¡†æ¶è¾ƒä¸ºäº†è§£ï¼Œå¹³å¸¸çƒ­è¡·äºé˜…è¯»ä¸€äº›å†…æ ¸çš„æºç ï¼Œå¸Œæœ›åˆ†äº«å‡ºæ¥ä¸å¤§å®¶äº’åŠ¨å’Œäº¤æµï¼Œè‡³äºç”Ÿæ´»æ„Ÿæ‚Ÿï¼Œå¿ƒçµé¸¡æ±¤ç¥é©¬çš„å°±å…äº†å§~</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">æ—¥å¿—</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">1</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#å‰è¨€"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JobManager-Leader-é€‰ä¸¾"><span class="nav-number">2.</span> <span class="nav-text">JobManager Leader é€‰ä¸¾</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å®¢æˆ·ç«¯JobGraphçš„æäº¤"><span class="nav-number">3.</span> <span class="nav-text">å®¢æˆ·ç«¯JobGraphçš„æäº¤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JobManageræ‰§è¡Œè®¡åˆ’ç”Ÿæˆ"><span class="nav-number">4.</span> <span class="nav-text">JobManageræ‰§è¡Œè®¡åˆ’ç”Ÿæˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ‰§è¡Œè®¡åˆ’-ExecutionGraph-çš„ç”Ÿæˆ"><span class="nav-number">4.1.</span> <span class="nav-text">æ‰§è¡Œè®¡åˆ’ ExecutionGraph çš„ç”Ÿæˆ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹-ExecutionJobVertex-çš„ç”Ÿæˆ"><span class="nav-number">4.1.1.</span> <span class="nav-text">æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ ExecutionJobVertex çš„ç”Ÿæˆ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹-ExecutionJobVertex-çš„è¿æ¥"><span class="nav-number">4.1.2.</span> <span class="nav-text">æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ ExecutionJobVertex çš„è¿æ¥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æ‰§è¡ŒèŠ‚ç‚¹å­ä»»åŠ¡-ExecutionVertex"><span class="nav-number">4.1.3.</span> <span class="nav-text">æ‰§è¡ŒèŠ‚ç‚¹å­ä»»åŠ¡ ExecutionVertex</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chenyuzhao</span>
</div>


<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'danny0405';
      var disqus_identifier = '2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/';

      var disqus_title = "flink ç‰©ç†è®¡åˆ’ç”Ÿæˆ";


      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      
        var disqus_config = function () {
            this.page.url = disqus_url;
            this.page.identifier = disqus_identifier;
            this.page.title = disqus_title;
        };
        run_disqus_script('embed.js');
      

    </script>
  









  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


</body>
</html>
