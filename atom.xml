<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ç‰å…†çš„åšå®¢</title>
  <subtitle>å¿ƒå¦‚æ­¢æ°´</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://danny0405.github.io/"/>
  <updated>2017-02-06T10:52:19.000Z</updated>
  <id>https://danny0405.github.io/</id>
  
  <author>
    <name>chenyuzhao</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>flink ç‰©ç†è®¡åˆ’ç”Ÿæˆ</title>
    <link href="https://danny0405.github.io/2017/02/06/flink%E7%89%A9%E7%90%86%E8%AE%A1%E5%88%92%E7%94%9F%E6%88%90/"/>
    <id>https://danny0405.github.io/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/</id>
    <published>2017-02-06T09:12:21.000Z</published>
    <updated>2017-02-06T10:52:19.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¸Šä¸€èŠ‚è®²åˆ°ä¸šåŠ¡ä»£ç <code>StreamExecutionEnvironment.execute()</code>ä¼šè§¦å‘jobçš„å®¢æˆ·ç«¯é€»è¾‘è®¡åˆ’<code>JobGraph</code> çš„ç”Ÿæˆï¼Œä¹‹åæ˜¯å®¢æˆ·ç«¯ä¸<code>JobManager</code>çš„äº¤äº’è¿‡ç¨‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ClusterClient line388</span></div><div class="line"><span class="function"><span class="keyword">public</span> JobExecutionResult <span class="title">run</span><span class="params">(JobGraph jobGraph, ClassLoader classLoader)</span> <span class="keyword">throws</span> ProgramInvocationException </span>&#123;</div><div class="line"></div><div class="line">   waitForClusterToBeReady();</div><div class="line"></div><div class="line">   <span class="keyword">final</span> LeaderRetrievalService leaderRetrievalService;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">      leaderRetrievalService = LeaderRetrievalUtils.createLeaderRetrievalService(flinkConfig);</div><div class="line">   &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ProgramInvocationException(<span class="string">"Could not create the leader retrieval service"</span>, e);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">      logAndSysout(<span class="string">"Submitting job with JobID: "</span> + jobGraph.getJobID() + <span class="string">". Waiting for job completion."</span>);</div><div class="line">      <span class="keyword">this</span>.lastJobExecutionResult = JobClient.submitJobAndWait(actorSystemLoader.get(),</div><div class="line">         leaderRetrievalService, jobGraph, timeout, printStatusDuringExecution, classLoader);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.lastJobExecutionResult;</div><div class="line">   &#125; <span class="keyword">catch</span> (JobExecutionException e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ProgramInvocationException(<span class="string">"The program execution failed: "</span> + e.getMessage(), e);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>leaderRetrievalService = LeaderRetrievalUtils.createLeaderRetrievalService(flinkConfig);</code>æ˜¯å¯åŠ¨è·å– leader JobManager çš„æœåŠ¡ï¼Œflink æ”¯æŒ JobManager HAï¼Œéœ€è¦é€šè¿‡ leader JobManager è·å–å½“å‰çš„ leader JobManagerï¼Œç¨å¾®ä»‹ç»ä¸‹è¿™ä¸ªæœåŠ¡ï¼š</p>
<h2 id="JobManager-Leader-é€‰ä¸¾"><a href="#JobManager-Leader-é€‰ä¸¾" class="headerlink" title="JobManager Leader é€‰ä¸¾"></a>JobManager Leader é€‰ä¸¾</h2><p>å…ˆæ¥çœ‹è·å– <code>LeaderRetrievalService</code>çš„é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//LeaderRetrievalUtils line61</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LeaderRetrievalService <span class="title">createLeaderRetrievalService</span><span class="params">(Configuration configuration)</span></span></div><div class="line">   <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">   RecoveryMode recoveryMode = getRecoveryMode(configuration);</div><div class="line"></div><div class="line">   <span class="keyword">switch</span> (recoveryMode) &#123;</div><div class="line">      <span class="keyword">case</span> STANDALONE:</div><div class="line">         <span class="keyword">return</span> StandaloneUtils.createLeaderRetrievalService(configuration);</div><div class="line">      <span class="keyword">case</span> ZOOKEEPER:</div><div class="line">         <span class="keyword">return</span> ZooKeeperUtils.createLeaderRetrievalService(configuration);</div><div class="line">      <span class="keyword">default</span>:</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Recovery mode "</span> + recoveryMode + <span class="string">" is not supported."</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆ flink ä¼šä¾æ®é…ç½®è·å– <code>RecoveryMode</code>ï¼Œ<code>RecoveryMode</code>ä¸€å…±ä¸¤ç§ï¼š<em>STANDALONE</em>å’Œ<em>ZOOKEEPER</em>ã€‚å¦‚æœç”¨æˆ·é…ç½®çš„æ˜¯<em>STANDALONE</em>ï¼Œä¼šç›´æ¥å»é…ç½®ä¸­è·å–<code>JobManager</code>çš„åœ°å€ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»<code>ZOOKEEPER</code>æ¨¡å¼ä¸‹çš„<code>JobManager</code>leaderçš„å‘ç°è¿‡ç¨‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ZooKeeperUtils line141</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ZooKeeperLeaderRetrievalService <span class="title">createLeaderRetrievalService</span><span class="params">(</span></span></div><div class="line">      Configuration configuration) <span class="keyword">throws</span> Exception &#123;</div><div class="line">   CuratorFramework client = startCuratorFramework(configuration);</div><div class="line">   String leaderPath = configuration.getString(ConfigConstants.ZOOKEEPER_LEADER_PATH,</div><div class="line">         ConfigConstants.DEFAULT_ZOOKEEPER_LEADER_PATH);</div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ZooKeeperLeaderRetrievalService(client, leaderPath);</div><div class="line">&#125;</div><div class="line"></div><div class="line">...</div><div class="line"><span class="comment">//ZooKeeperLeaderRetrievalService line103</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nodeChanged</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			LOG.debug(<span class="string">"Leader node has changed."</span>);</div><div class="line"></div><div class="line">			ChildData childData = cache.getCurrentData();</div><div class="line"></div><div class="line">			String leaderAddress;</div><div class="line">			UUID leaderSessionID;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (childData == <span class="keyword">null</span>) &#123;</div><div class="line">				leaderAddress = <span class="keyword">null</span>;</div><div class="line">				leaderSessionID = <span class="keyword">null</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">byte</span>[] data = childData.getData();</div><div class="line"></div><div class="line">				<span class="keyword">if</span> (data == <span class="keyword">null</span> || data.length == <span class="number">0</span>) &#123;</div><div class="line">					leaderAddress = <span class="keyword">null</span>;</div><div class="line">					leaderSessionID = <span class="keyword">null</span>;</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(data);</div><div class="line">					ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(bais);</div><div class="line"></div><div class="line">					leaderAddress = ois.readUTF();</div><div class="line">					leaderSessionID = (UUID) ois.readObject();</div></pre></td></tr></table></figure>
<p>è¿™é‡Œ flink ä¼šé¦–å…ˆå°è¯•è¿æ¥ zookeeperï¼Œåˆ©ç”¨ zookeeperçš„leaderé€‰ä¸¾æœåŠ¡å‘ç°leaderèŠ‚ç‚¹çš„åœ°å€å’Œå½“å‰çš„ sessionidï¼Œsession idçš„ä½œç”¨ä»‹ç»<code>JobManager</code>çš„æ—¶å€™ä¼šè¯¦ç»†è¯´æ˜</p>
<h2 id="å®¢æˆ·ç«¯JobGraphçš„æäº¤"><a href="#å®¢æˆ·ç«¯JobGraphçš„æäº¤" class="headerlink" title="å®¢æˆ·ç«¯JobGraphçš„æäº¤"></a>å®¢æˆ·ç«¯JobGraphçš„æäº¤</h2><p>å®¢æˆ·ç«¯çš„<code>JobGraph</code>ç”Ÿæˆä¹‹åï¼Œé€šè¿‡ä¸Šé¢çš„<code>LeaderRetrivalService</code>è·å–<code>JobManager</code>çš„åœ°å€ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å°†<code>JobGraph</code>æäº¤ç»™<code>JobManager</code>å»æ‰§è¡Œã€‚flink çš„æ ¸å¿ƒè¿›ç¨‹é€šä¿¡æ˜¯é€šè¿‡ Akka æ¥å®Œæˆçš„ï¼Œ<code>JobManager</code>ã€<code>TaskManager</code>éƒ½æ˜¯ä¸€ä¸ª Akka systemï¼Œæ‰€ä»¥è¿™é‡Œçš„æäº¤é¦–å…ˆéœ€è¦ç”Ÿæˆä¸€ä¸ªå®¢æˆ·ç«¯actorä¸<code>JobManager</code>äº¤äº’ï¼Œç„¶åæ‰§è¡Œrpcå‘½ä»¤ï¼Œå…·ä½“è§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//JobClient line98</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobExecutionResult <span class="title">submitJobAndWait</span><span class="params">(</span></span></div><div class="line">      ActorSystem actorSystem,</div><div class="line">      LeaderRetrievalService leaderRetrievalService,</div><div class="line">      JobGraph jobGraph,</div><div class="line">      FiniteDuration timeout,</div><div class="line">      <span class="keyword">boolean</span> sysoutLogUpdates,</div><div class="line">      ClassLoader classLoader) <span class="keyword">throws</span> JobExecutionException &#123;</div><div class="line"></div><div class="line">   ...</div><div class="line"></div><div class="line">   <span class="comment">// for this job, we create a proxy JobClientActor that deals with all communication with</span></div><div class="line">   <span class="comment">// the JobManager. It forwards the job submission, checks the success/failure responses, logs</span></div><div class="line">   <span class="comment">// update messages, watches for disconnect between client and JobManager, ...</span></div><div class="line"></div><div class="line">   Props jobClientActorProps = JobClientActor.createJobClientActorProps(</div><div class="line">      leaderRetrievalService,</div><div class="line">      timeout,</div><div class="line">      sysoutLogUpdates);</div><div class="line"></div><div class="line">   ActorRef jobClientActor = actorSystem.actorOf(jobClientActorProps);</div><div class="line"></div><div class="line">   <span class="comment">// first block handles errors while waiting for the result</span></div><div class="line">   Object answer;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">      Future&lt;Object&gt; future = Patterns.ask(jobClientActor,</div><div class="line">            <span class="keyword">new</span> JobClientMessages.SubmitJobAndWait(jobGraph),</div><div class="line">            <span class="keyword">new</span> Timeout(AkkaUtils.INF_TIMEOUT()));</div><div class="line"></div><div class="line">      answer = Await.result(future, AkkaUtils.INF_TIMEOUT());</div><div class="line">   &#125;</div><div class="line">   ...</div></pre></td></tr></table></figure>
<p>åœ¨<code>JobClientActor</code>å¯åŠ¨ä¹‹å‰ä¼šå¯åŠ¨<code>LeaderRetrivalService</code>ï¼Œ<code>LeaderRetrivalService</code>å¯åŠ¨ä¹‹åä¼šé€šçŸ¥å®ƒçš„ Listener <code>JobClientActor</code>è·å–<code>JobManager</code>çš„åœ°å€å’Œå½“å‰ session idã€‚ä¹‹åç»è¿‡æ¶ˆæ¯è·¯ç”±è·³è½¬åˆ°æäº¤çš„æ ¸å¿ƒé€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//JobClientActor line354</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">tryToSubmitJob</span><span class="params">(<span class="keyword">final</span> JobGraph jobGraph)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.jobGraph = jobGraph;</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (isConnected()) &#123;</div><div class="line">      LOG.info(<span class="string">"Sending message to JobManager &#123;&#125; to submit job &#123;&#125; (&#123;&#125;) and wait for progress"</span>,</div><div class="line">         jobManager.path().toString(), jobGraph.getName(), jobGraph.getJobID());</div><div class="line"></div><div class="line">      Futures.future(<span class="keyword">new</span> Callable&lt;Object&gt;() &#123;</div><div class="line">         <span class="meta">@Override</span></div><div class="line">         <span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            ActorGateway jobManagerGateway = <span class="keyword">new</span> AkkaActorGateway(jobManager, leaderSessionID);</div><div class="line"></div><div class="line">            LOG.info(<span class="string">"Upload jar files to job manager &#123;&#125;."</span>, jobManager.path());</div><div class="line"></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">               jobGraph.uploadUserJars(jobManagerGateway, timeout);</div></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç æœ‰æ‰€çœç•¥ğŸ˜ã€‚</p>
<p>æ€»ç»“ä¸‹ä¸Šé¢çš„è¿‡ç¨‹ï¼š</p>
<img src="/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/jobclient-to-jobmanager.png" alt="jobclient-to-jobmanager" title="jobclient-to-jobmanager">
<ul>
<li>å¯åŠ¨<code>JobClientActor</code>ç”¨æ¥å’Œ<code>JobManager</code>äº¤äº’</li>
<li>å¯åŠ¨<code>LeaderRetrievalService</code>è·å–<code>JobManager</code>çš„åœ°å€</li>
<li>ä¸Šä¼ ç”¨æˆ· jar åŒ…</li>
<li>æäº¤ SubmitJob å‘½ä»¤</li>
</ul>
<h2 id="JobManageræ‰§è¡Œè®¡åˆ’ç”Ÿæˆ"><a href="#JobManageræ‰§è¡Œè®¡åˆ’ç”Ÿæˆ" class="headerlink" title="JobManageræ‰§è¡Œè®¡åˆ’ç”Ÿæˆ"></a>JobManageræ‰§è¡Œè®¡åˆ’ç”Ÿæˆ</h2><p><code>JobManager</code>è´Ÿè´£æ¥æ”¶ flink çš„ä½œä¸šï¼Œè°ƒåº¦ taskï¼Œæ”¶é›† job çš„çŠ¶æ€ã€ç®¡ç† TaskManagersã€‚è¢«å®ç°ä¸ºä¸€ä¸ª akka actorã€‚</p>
<p>å®¢æˆ·ç«¯ä¸Šä¼ å®Œ jar åŒ…å’Œ<code>JobGraph</code>ï¼Œflink ä¼šè¿›ä¸€æ­¥è§£æå°è£…æˆè¿è¡Œæ—¶çš„æ‰§è¡Œè®¡åˆ’<code>ExecutionGraph</code>ï¼Œ<code>JobManager</code>çš„æ„é€ å™¨åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥äº†å¾ˆå¤šç»„ä»¶ï¼Œè¿™é‡Œç®€å•åˆ—ä¸¾ä¸‹åŠŸèƒ½æ–¹ä¾¿åé¢çš„é€»è¾‘å±•å¼€ï¼Œå…·ä½“çš„ç»†èŠ‚å°†ä¼šåœ¨ä¸‹ä¸€èŠ‚è®²è§£ã€‚</p>
<ul>
<li><code>BlobServer</code>ï¼šå®ç°äº† BOLB serverï¼Œå…¶ä¼šç›‘å¬æ”¶åˆ°çš„ requestsï¼Œå¹¶ä¼šåˆ›å»º ç›®å½•ç»“æ„å­˜å‚¨ BLOBS ã€æŒä¹…åŒ–ã€‘æˆ–è€…ä¸´æ—¶æ€§çš„ç¼“å­˜ä»–ä»¬</li>
<li><code>InstanceManager</code>ï¼šTaskManageråœ¨<code>flink</code>æ¡†æ¶å†…éƒ¨è¢«å«åš<code>Instance</code>ï¼Œflinké€šè¿‡<code>InstanceManager</code>ç®¡ç† flink é›†ç¾¤ä¸­å½“å‰æ‰€æœ‰æ´»è·ƒçš„ TaskManagerï¼ŒåŒ…æ‹¬æ¥æ”¶å¿ƒè·³ï¼Œé€šçŸ¥ InstanceListener Instance çš„ç”Ÿæˆä¸æ­»äº¡ï¼Œä¸€ä¸ªå…¸å‹çš„ <code>InstanceListener</code> ä¸º flink çš„ Scheduler</li>
<li><code>BlobLibraryCacheManager</code>ï¼šflink job çš„ jar åŒ…å­˜å‚¨æœåŠ¡ï¼Œä½¿ç”¨ä¸Šé¢çš„ BlobServer å®Œæˆã€‚</li>
<li><code>MemoryArchivist</code>å¤‡æ¡ˆå·²æäº¤çš„flinkä½œä¸šï¼ŒåŒ…æ‹¬<code>JobGraph</code>ã€<code>ExecutionGraph</code>ç­‰</li>
<li>â€‹</li>
<li><code>ZooKeeperCompletedCheckpointStore</code>ï¼šè´Ÿè´£æŒä¹…åŒ– job çš„ checkpoint ä¿¡æ¯ï¼Œä¸€ä¸ª job å¯ä»¥æŒä¹…åŒ–å¤šä¸ª checkpointï¼Œä½†åªæœ‰æœ€æ–°çš„ä¼šè¢«ä½¿ç”¨ï¼Œå…·ä½“æ–¹å¼ä¸ºå…ˆåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æŒä¹…åŒ–ä¸€ä»½ï¼Œå†å°†æ–‡ä»¶å¥æŸ„æ›´æ–°åˆ° zkï¼Œå¹¶åœ¨ zkä¸Šä¾æ¬¡é€’å¢èŠ‚ç‚¹è·¯å¾„å·ï¼Œzk ä¸Šä¿å­˜äº†æœ€è¿‘çš„ 10 æ¬¡ checkpoint</li>
<li>SavepointStoreï¼šflink çš„çŠ¶æ€å­˜å‚¨ï¼Œè´Ÿè´£å­˜å‚¨ç®—å­å†…éƒ¨å®šä¹‰çš„çŠ¶æ€ï¼Œä¸ checkpoint ç¨æœ‰åŒºåˆ«ï¼Œåè€…ç”± flink æ¡†æ¶æ¥ç»´æŠ¤</li>
</ul>
<p><em>ä¸ºäº†å¯¹<code>JobManager</code>ä¸­æ‰€èµ·çš„ actors æœåŠ¡æœ‰æ‰€äº†è§£ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹<code>JobManager</code>çš„å¯åŠ¨è¿‡ç¨‹</em></p>
<p>ç®€å•åˆ†æå¾—çŸ¥<code>line2049: runJobManager</code>æ˜¯JobManagerå¯åŠ¨çš„å…¥å£ï¼Œåœ¨è·å–<code>JobManager</code>å¯åŠ¨çš„ä¸»æœºå’Œç«¯å£åï¼Œå˜å¼€å§‹å¯åŠ¨ actor systemï¼Œweb uiä»¥åŠå…¶ä»– actorsï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//JobManager line2008</span></div><div class="line"><span class="function">def <span class="title">runJobManager</span><span class="params">(</span></span></div><div class="line">    configuration: Configuration,</div><div class="line">    executionMode: JobManagerMode,</div><div class="line">    listeningAddress: String,</div><div class="line">    listeningPort: Int)</div><div class="line">  : Unit = &#123;</div><div class="line"></div><div class="line">  val (jobManagerSystem, _, _, webMonitorOption, _) = startActorSystemAndJobManagerActors(</div><div class="line">    configuration,</div><div class="line">    executionMode,</div><div class="line">    listeningAddress,</div><div class="line">    listeningPort,</div><div class="line">    classOf[JobManager],</div><div class="line">    classOf[MemoryArchivist],</div><div class="line">    Option(classOf[StandaloneResourceManager])</div><div class="line">  )</div><div class="line"></div><div class="line">  <span class="comment">// block until everything is shut down</span></div><div class="line">  jobManagerSystem.awaitTermination()</div></pre></td></tr></table></figure>
<p>å…·ä½“çš„å¯åŠ¨é€»è¾‘åœ¨<code>startActorSystemAndJobManagerActors</code>æ–¹æ³•ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//JobManager line2150</span></div><div class="line"><span class="function">def <span class="title">startActorSystemAndJobManagerActors</span><span class="params">(</span></span></div><div class="line">    configuration: Configuration,</div><div class="line">    executionMode: JobManagerMode,</div><div class="line">    listeningAddress: String,</div><div class="line">    listeningPort: Int,</div><div class="line">    jobManagerClass: Class[_ &lt;: JobManager],</div><div class="line">    archiveClass: Class[_ &lt;: MemoryArchivist],</div><div class="line">    resourceManagerClass: Option[Class[_ &lt;: FlinkResourceManager[_]]])</div><div class="line">  : <span class="params">(ActorSystem, ActorRef, ActorRef, Option[WebMonitor], Option[ActorRef])</span> = &#123;</div><div class="line">  ...</div></pre></td></tr></table></figure>
<p>ç®€å•åˆ—ä¸¾ä¸‹é€»è¾‘ï¼š</p>
<ul>
<li>JobManager ç¨‹åºçš„ä¸»å…¥å£ï¼Œç”± ApplicationMasterBase å‘èµ·</li>
<li>line 2174 ä½¿ç”¨ Json é…ç½® Akka å¹¶ç”Ÿæˆ ActorSystem</li>
<li>line 2197 åˆå§‹åŒ– ZooKeeperLeaderRetrievalServiceï¼ŒJobManageråœ¨å¯åŠ¨çš„æ—¶å€™ä¼šä»¥ LeaderRetrievalListener çš„èº«ä»½å°†è‡ªå·±æ³¨å†Œè¿›æ¥ï¼Œè¯¥ service è´Ÿè´£ç›‘å¬æœ€æ–°çš„ leader ä¿¡æ¯ï¼Œå½“å‘ç”Ÿæ”¹å˜æ—¶ é€šçŸ¥æ‰€æœ‰ listenerã€æ‰€æœ‰çš„ JobManagerã€‘</li>
<li>line 2220 å¯åŠ¨ YarnJobManager å’Œ MemoryArchivist actorsã€è¿™é‡Œå¹¶æ²¡æœ‰å¯åŠ¨ã€‘</li>
<li>line2268 å¯åŠ¨ã€flinkåŸºæœ¬ç»„ä»¶å’ŒJobGraphçš„ç”Ÿæˆä¸€èŠ‚ä¸­æåˆ°çš„ã€‘FlinkResourceManager</li>
<li>line 2620 createJobManagerComponents è·å–ä»¥ä¸Šä¸¤ä¸ªç»„ä»¶å¿…è¦çš„é…ç½®ï¼Œå¹¶åˆå§‹åŒ–ç›¸å…³æœåŠ¡ å…·ä½“è§ã€ flink JobManager ä¸­æ‰€èµ·çš„æœåŠ¡ã€‘è¿™é‡Œåœ¨åˆå§‹åŒ–ç›¸å…³ç»„ä»¶åä¼šåˆå§‹åŒ– JobManagerï¼Œakka actorOf æ–¹æ³•ä¼ å…¥çš„å±æ€§ä¸ºæ„é€ å™¨ä¸­å‚æ•°ï¼Œé‡è½½ preStart å’Œ postStop æ–¹æ³•ä¼šåœ¨ actor å¯åŠ¨å’Œå…³é—­å ç›¸ç»§æ‰§è¡Œï¼ŒJobManager ä¼šåœ¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¸­å¯åŠ¨å’Œåœæ­¢è¿™äº›æœåŠ¡</li>
</ul>
<p>åˆ°è¿™é‡Œä¸€ä¸ªå®Œæ•´çš„<code>JobManager</code> actor ä¾¿å¯åŠ¨èµ·æ¥äº†ğŸ˜œ</p>
<p>æ—¢ç„¶æ˜¯ actor ï¼Œé‚£ä¹ˆä»–çš„æ ¸å¿ƒé€»è¾‘ä¸€å®šæ˜¯å„ç§æ¶ˆæ¯çš„è·¯ç”±å’Œå¤„ç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//JobManager line304</span></div><div class="line">override def handleMessage: Receive = &#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">case</span> <span class="title">GrantLeadership</span><span class="params">(newLeaderSessionID)</span> </span>=&gt;</div><div class="line">    log.info(s<span class="string">"JobManager $getAddress was granted leadership with leader session ID "</span> +</div><div class="line">      s<span class="string">"$newLeaderSessionID."</span>)</div><div class="line"></div><div class="line">    leaderSessionID = newLeaderSessionID</div></pre></td></tr></table></figure>
<p>ä»‹ç»ä¸‹è¿™é‡Œæ¯”è¾ƒé‡è¦çš„å‡ ç§æ¶ˆæ¯ï¼š</p>
<ul>
<li>å¤„ç†æ¶ˆæ¯çš„æ ¸å¿ƒæ–¹æ³•</li>
<li>GrantLeadership è·å¾—leaderæˆæƒï¼Œå°†è‡ªèº«è¢«åˆ†å‘åˆ°çš„ session id å†™åˆ° zookeeperï¼Œå¹¶æ¢å¤æ‰€æœ‰çš„ jobs.</li>
<li>RevokeLeadership å‰¥å¤ºleaderæˆæƒï¼Œæ‰“æ–­æ¸…ç©ºæ‰€æœ‰çš„ job ä¿¡æ¯ï¼Œä½†æ˜¯ä¿ç•™ä½œä¸šç¼“å­˜ï¼Œæ³¨é”€æ‰€æœ‰çš„ TaskManagers. </li>
<li>RegisterTaskManagers æ³¨å†Œ TaskManagerï¼Œå¦‚æœä¹‹å‰å·²ç»æ³¨å†Œè¿‡ï¼Œåˆ™åªç»™å¯¹åº”çš„ Instance å‘é€æ¶ˆæ¯ï¼Œå¦åˆ™å¯åŠ¨æ³¨å†Œé€»è¾‘ï¼šåœ¨ InstanceManager ä¸­æ³¨å†Œè¯¥ Instance çš„ä¿¡æ¯ï¼Œå¹¶åœæ­¢ Instance BlobLibraryCacheManager çš„ç«¯å£ã€ä¾›ä¸‹è½½ lib åŒ…ç”¨ã€‘ï¼ŒåŒæ—¶ä½¿ç”¨ watch ç›‘å¬ task manager çš„å­˜æ´»</li>
<li>SubmitJob æäº¤ jobGraph</li>
</ul>
<h3 id="æ‰§è¡Œè®¡åˆ’-ExecutionGraph-çš„ç”Ÿæˆ"><a href="#æ‰§è¡Œè®¡åˆ’-ExecutionGraph-çš„ç”Ÿæˆ" class="headerlink" title="æ‰§è¡Œè®¡åˆ’ ExecutionGraph çš„ç”Ÿæˆ"></a>æ‰§è¡Œè®¡åˆ’ ExecutionGraph çš„ç”Ÿæˆ</h3><p>flink çš„è¿è¡Œæ—¶æ‰§è¡Œè®¡åˆ’ä¸º ExecutionGraphï¼ŒExecutionGraph å¯¹åº”ä¹‹å‰çš„ JobGraphï¼Œä¸€ä¸ª ExecutionGraph åŒ…å«å¤šä¸ª ExecutionJobVertex èŠ‚ç‚¹ï¼ŒJobGraph çš„ JobVertexï¼Œæ¯ä¸ª ExecutionJobVertex èŠ‚ç‚¹çš„å¹¶å‘å­ task å¯¹åº”ä¸€ä¸ª ExecutionVertexï¼Œæ¯ä¸ª ExecutionVertex çš„ä¸€æ¬¡ attempt æ‰§è¡Œè¢«æŠ½è±¡ä¸ºä¸€æ¬¡ Executionï¼Œå…·ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/flink-job-vertex-to-execution.png" alt="flink-job-vertex-to-execution.png" title="flink-job-vertex-to-execution.png">
<p><em>ä¸‹é¢ä¼šå¯¹æ¯ä¸ªæŠ½è±¡åšè¯¦ç»†çš„ä»‹ç»</em></p>
<p>ExecutionGraph çš„åˆ›å»ºæ˜¯åœ¨ JobManager æ¥æ”¶ SubmitJob å‘½ä»¤åå¼€å§‹çš„ï¼Œè¿™æ¡æ¶ˆæ¯ä¼šè¢«è·¯ç”±åˆ°æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//JobManager line1048</span></div><div class="line"><span class="function"><span class="keyword">private</span> def <span class="title">submitJob</span><span class="params">(jobGraph: JobGraph, jobInfo: JobInfo, isRecovery: Boolean = <span class="keyword">false</span>)</span>: Unit </span>= &#123;</div><div class="line">  <span class="keyword">if</span> (jobGraph == <span class="keyword">null</span>) &#123;</div><div class="line">    jobInfo.client ! decorateMessage(JobResultFailure(</div><div class="line">      <span class="keyword">new</span> SerializedThrowable(</div><div class="line">        <span class="keyword">new</span> JobSubmissionException(<span class="keyword">null</span>, <span class="string">"JobGraph must not be null."</span>)</div><div class="line">      )</div><div class="line">    ))</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>å…¶é€»è¾‘æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>æäº¤ä½œä¸š</li>
<li>å…·ä½“çš„ç»„ä»¶äº¤äº’è¿‡ç¨‹ Client.java line169 runBlocking -&gt; JobClient.java line102 submitJobAndWait -&gt; JobClientActor.java line 337 tryToSubmitJob  è¿™é‡Œä¼šå…ˆä¸Šä¼  jars åˆ° JobManager çš„ BlobServerï¼Œç„¶åå‘èµ·æäº¤å‘½ä»¤</li>
<li>line1068: è®¾ç½®ç”¨æˆ·libåŒ…ï¼Œä½¿ç”¨  LibraryCacheManager book job çš„jaråŒ…ï¼Œç”±äºä¹‹å‰åŒ…å·²ä¸Šä¼ ï¼Œè¿™ä¼šåˆ›å»ºjobId å’Œ jars ä»¥åŠclass paths çš„å¯¹åº”å…³ç³»</li>
<li>line1114: å°† JobGraph è½¬æ¢ä¸º ExecutionGraph é€»è¾‘è®¡åˆ’è½¬åŒ–ä¸ºç‰©ç†è®¡åˆ’ã€åè€…ç»´æŠ¤ data flow çš„åè°ƒæ‰§è¡Œã€è¿æ¥ã€è®¡ç®—ä¸­é—´ç»“æœã€‘å…·ä½“è§ç« èŠ‚ï¼š flink runtime</li>
<li>line 1178 ExecutionJobVertex åœ¨æ­¤å¤„ç”Ÿæˆï¼Œé€šè¿‡ JobGraph ä¾ç…§æ•°æ®æºé¡ºåºè·å–ä¸‹æ¸¸ JobVertexï¼Œå…·ä½“ç®—æ³•å¦‚ä¸‹ï¼š</li>
</ul>
<img src="/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/job-graph-node-sort.png" alt="job-graph-node-sort.png" title="job-graph-node-sort.png">
<p>flinkæ’åºèŠ‚ç‚¹çš„é¡ºåºï¼š</p>
<ul>
<li>æ•°æ®æºèŠ‚ç‚¹</li>
<li>åªæœ‰ä¸€ä¸ªä¸Šæ¸¸çš„èŠ‚ç‚¹</li>
<li>sinkèŠ‚ç‚¹</li>
</ul>
<p><em>ä¾‹å¦‚ä¸Šå›¾çš„ä¸¤ä¸ªæ‹“æ‰‘ç»“æ„ï¼Œå·¦è¾¹èŠ‚ç‚¹æ’åºå®Œçš„é¡ºåºä¸ºï¼š 1 2 3 4 5 å³è¾¹çš„èŠ‚ç‚¹æ’åºå®Œçš„é¡ºåºä¸ºï¼š1 2 3 5 4 6</em></p>
<p>é‚£ä¹ˆ flink ä¸ºä»€ä¹ˆè¦å°† JobGraph è½¬æ¢ä¸º ExecutionGraph ï¼Œå¹¶ä¸”æ’åºè¿™äº›èŠ‚ç‚¹å‘¢ï¼ŸExecutionGraph ä»£è¡¨äº†è¿è¡Œæ—¶çš„æ‰§è¡Œè®¡åˆ’ï¼ŒåŒ…æ‹¬ task çš„å¹¶å‘ã€è¿æ¥ã€ä¸­é—´ç»“æœçš„ç»´æŠ¤ç­‰ï¼Œæ’åºçš„ç›®çš„æ˜¯ç»™ task çš„éƒ¨ç½²è®¾ç½®å…ˆåé¡ºåºï¼Œæƒ³æ¥ä¹Ÿæ˜¯å¾ˆè‡ªç„¶çš„ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ ExecutionGraph çš„æ„é€ å™¨å°±èƒ½äº†è§£ä¸ªå¤§æ¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ExecutionGraph</span><span class="params">(</span></span></div><div class="line">      ExecutionContext executionContext,</div><div class="line">      JobID jobId,</div><div class="line">      String jobName,</div><div class="line">      Configuration jobConfig,</div><div class="line">      SerializedValue&lt;ExecutionConfig&gt; serializedConfig,</div><div class="line">      FiniteDuration timeout,</div><div class="line">      RestartStrategy restartStrategy,</div><div class="line">      List&lt;BlobKey&gt; requiredJarFiles,</div><div class="line">      List&lt;URL&gt; requiredClasspaths,</div><div class="line">      ClassLoader userClassLoader,</div><div class="line">      MetricGroup metricGroup) &#123;</div><div class="line"></div><div class="line">   ...</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.executionContext = executionContext;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.jobID = jobId;</div><div class="line">   <span class="keyword">this</span>.jobName = jobName;</div><div class="line">   <span class="keyword">this</span>.jobConfiguration = jobConfig;</div><div class="line">   <span class="keyword">this</span>.userClassLoader = userClassLoader;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.tasks = <span class="keyword">new</span> ConcurrentHashMap&lt;JobVertexID, ExecutionJobVertex&gt;();</div><div class="line">   <span class="keyword">this</span>.intermediateResults = <span class="keyword">new</span> ConcurrentHashMap&lt;IntermediateDataSetID, IntermediateResult&gt;();</div><div class="line">   <span class="keyword">this</span>.verticesInCreationOrder = <span class="keyword">new</span> ArrayList&lt;ExecutionJobVertex&gt;();</div><div class="line">   <span class="keyword">this</span>.currentExecutions = <span class="keyword">new</span> ConcurrentHashMap&lt;ExecutionAttemptID, Execution&gt;();</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.jobStatusListenerActors  = <span class="keyword">new</span> CopyOnWriteArrayList&lt;ActorGateway&gt;();</div><div class="line">   <span class="keyword">this</span>.executionListenerActors = <span class="keyword">new</span> CopyOnWriteArrayList&lt;ActorGateway&gt;();</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.stateTimestamps = <span class="keyword">new</span> <span class="keyword">long</span>[JobStatus.values().length];</div><div class="line">   <span class="keyword">this</span>.stateTimestamps[JobStatus.CREATED.ordinal()] = System.currentTimeMillis();</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.requiredJarFiles = requiredJarFiles;</div><div class="line">   <span class="keyword">this</span>.requiredClasspaths = requiredClasspaths;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.serializedExecutionConfig = checkNotNull(serializedConfig);</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.timeout = timeout;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.restartStrategy = restartStrategy;</div><div class="line"></div><div class="line">   metricGroup.gauge(RESTARTING_TIME_METRIC_NAME, <span class="keyword">new</span> RestartTimeGauge());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»æ„é€ å™¨å¯ä»¥çœ‹å‡ºï¼ŒExecutionGraph ä¼šç»´æŠ¤å½“å‰çš„é€»è¾‘è®¡åˆ’ä¿¡æ¯ã€å°±æ˜¯æœ‰å“ªäº›taskè¦æ‰§è¡Œã€‘ã€ä¸­é—´ç»“æœç”Ÿæˆä¿¡æ¯ï¼Œå½“å‰æ­£åœ¨è¿è¡Œçš„ taskï¼Œè´Ÿè´£ job å’Œ task çŠ¶æ€åˆ‡æ¢çš„é€šçŸ¥ç­‰ã€‚</p>
<h4 id="æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹-ExecutionJobVertex-çš„ç”Ÿæˆ"><a href="#æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹-ExecutionJobVertex-çš„ç”Ÿæˆ" class="headerlink" title="æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ ExecutionJobVertex çš„ç”Ÿæˆ"></a>æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ ExecutionJobVertex çš„ç”Ÿæˆ</h4><p>attachJobGraph æ˜¯ ExecutionGraph æ„é€ å›¾ç»“æ„çš„æ ¸å¿ƒæ–¹æ³•ï¼Œè€Œå…¶ä¸­æœ€å…³é”®çš„é€»è¾‘æ˜¯ æ‰§è¡ŒèŠ‚ç‚¹ ExecutionJobGraph çš„åˆ›å»ºï¼Œä¸‹é¢è¯¦ç»†åˆ†æä¸‹å…¶åˆ›å»ºè¿‡ç¨‹å’Œæ ¸å¿ƒåŠŸèƒ½ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ExecutionJobVertex line95</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ExecutionJobVertex</span><span class="params">(ExecutionGraph graph, JobVertex jobVertex,</span></span></div><div class="line">                  <span class="keyword">int</span> defaultParallelism, FiniteDuration timeout, <span class="keyword">long</span> createTimestamp)</div><div class="line">      <span class="keyword">throws</span> JobException</div><div class="line">&#123;</div><div class="line">   ...</div><div class="line">   <span class="keyword">this</span>.graph = graph;</div><div class="line">   <span class="keyword">this</span>.jobVertex = jobVertex;</div><div class="line"></div><div class="line">   <span class="keyword">int</span> vertexParallelism = jobVertex.getParallelism();</div><div class="line">   <span class="keyword">int</span> numTaskVertices = vertexParallelism &gt; <span class="number">0</span> ? vertexParallelism : defaultParallelism;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.parallelism = numTaskVertices;</div><div class="line">   <span class="keyword">this</span>.taskVertices = <span class="keyword">new</span> ExecutionVertex[numTaskVertices];</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.inputs = <span class="keyword">new</span> ArrayList&lt;IntermediateResult&gt;(jobVertex.getInputs().size());</div><div class="line"></div><div class="line">   <span class="comment">// take the sharing group</span></div><div class="line">   <span class="keyword">this</span>.slotSharingGroup = jobVertex.getSlotSharingGroup();</div><div class="line">   <span class="keyword">this</span>.coLocationGroup = jobVertex.getCoLocationGroup();</div><div class="line">   ...</div><div class="line"></div><div class="line">   <span class="comment">// create the intermediate results</span></div><div class="line">   <span class="keyword">this</span>.producedDataSets = <span class="keyword">new</span> IntermediateResult[jobVertex.getNumberOfProducedIntermediateDataSets()];</div><div class="line"></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jobVertex.getProducedDataSets().size(); i++) &#123;</div><div class="line">      <span class="keyword">final</span> IntermediateDataSet result = jobVertex.getProducedDataSets().get(i);</div><div class="line"></div><div class="line">      <span class="keyword">this</span>.producedDataSets[i] = <span class="keyword">new</span> IntermediateResult(</div><div class="line">            result.getId(),</div><div class="line">            <span class="keyword">this</span>,</div><div class="line">            numTaskVertices,</div><div class="line">            result.getResultType(),</div><div class="line">            result.getEagerlyDeployConsumers());</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// create all task vertices</span></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numTaskVertices; i++) &#123;</div><div class="line">      ExecutionVertex vertex = <span class="keyword">new</span> ExecutionVertex(<span class="keyword">this</span>, i, <span class="keyword">this</span>.producedDataSets, timeout, createTimestamp);</div><div class="line">      <span class="keyword">this</span>.taskVertices[i] = vertex;</div><div class="line">   &#125;</div><div class="line">   ...</div><div class="line"></div><div class="line">   <span class="comment">// set up the input splits, if the vertex has any</span></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">      <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">      InputSplitSource&lt;InputSplit&gt; splitSource = (InputSplitSource&lt;InputSplit&gt;) jobVertex.getInputSplitSource();</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (splitSource != <span class="keyword">null</span>) &#123;</div><div class="line">         inputSplits = splitSource.createInputSplits(numTaskVertices);</div><div class="line"></div><div class="line">         <span class="keyword">if</span> (inputSplits != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (splitSource <span class="keyword">instanceof</span> StrictlyLocalAssignment) &#123;</div><div class="line">               inputSplitsPerSubtask = computeLocalInputSplitsPerTask(inputSplits);</div><div class="line">               splitAssigner = <span class="keyword">new</span> PredeterminedInputSplitAssigner(inputSplitsPerSubtask);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">               splitAssigner = splitSource.getInputSplitAssigner(inputSplits);</div><div class="line">            &#125;</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span> &#123;</div><div class="line">         inputSplits = <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> JobException(<span class="string">"Creating the input splits caused an error: "</span> + t.getMessage(), t);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   finishedSubtasks = <span class="keyword">new</span> <span class="keyword">boolean</span>[parallelism];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç®€è¦ä»‹ç»ä¸‹å…¶æ„å»ºé€»è¾‘ï¼š</p>
<ul>
<li>ä¾æ®å¯¹åº”çš„ JobVetex çš„å¹¶å‘ç”Ÿæˆå¯¹åº”ä¸ªæ•°çš„ ExecutionVertexï¼Œä¸€ä¸ª ExecutionVertex ä»£è¡¨ä¸€ä¸ª ExecutionJobVertex çš„å¹¶å‘å­ task</li>
<li>è®¾ç½® SlotSharingGroup å’Œ CoLocationGroupï¼Œè¿™ä¸¤ä¸ªç»„ä»¶æ˜¯ flink è¿è¡Œæ—¶ä»»åŠ¡è°ƒåº¦çš„æ ¸å¿ƒæŠ½è±¡ï¼Œä¼šçº¦æŸ flink è°ƒåº¦ task çš„ç­–ç•¥ï¼Œåœ¨ flink ä»»åŠ¡è°ƒåº¦ç®—æ³• ä¸€èŠ‚ä¼šè¯¦ç»†ä»‹ç»</li>
<li>å°†åŸæ¥ JobVertex çš„ä¸­é—´ç»“æœ IntermediateDataSet è½¬åŒ–ä¸º IntermediateResultï¼Œåè€…åœ¨å‰è€…çš„åŸºç¡€ä¸ŠåŠ å…¥äº† å½“å‰æ­£åœ¨è¿è¡Œçš„ producer ä¿¡æ¯ï¼Œæ˜¯çœŸæ­£å…³äºè¿è¡Œæ—¶ä¸­é—´æ•°æ®çš„æŠ½è±¡</li>
<li>å¦‚æœå¯¹åº”çš„ job èŠ‚ç‚¹æ˜¯æ•°æ®æºèŠ‚ç‚¹ï¼Œä¼šè·å–å…¶ InputSplitSourceï¼ŒInputSplitSource æ§åˆ¶äº†æ•°æ®æºå¹¶å‘å­ task å’Œç”Ÿäº§çš„ InputSplit çš„å¯¹åº”å…³ç³»ï¼Œä¸€ä¸ª InputSplit ä»£è¡¨ä¸€ä¸ªæ•°æ®æºåˆ†ç‰‡ï¼Œå¯¹äº flink streaming æ¥è¯´ï¼ŒInputSplitSource å°±æ˜¯ä¸€ä¸ª InputFormatï¼Œå¯¹åº”ä¸€ä¸ªè¾“å…¥æº task</li>
<li>è¿™é‡Œçš„ InputSplitSource æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è®¾ç½®è¿›å»çš„å‘¢ï¼Ÿè§<code>JobManager line1163 vertex.initializeOnMaster(userCodeLoader)</code>ä»¥åŠ<code>StreamingJobGraphGenerator.java line 278 createDataSourceVertex</code></li>
</ul>
<h4 id="æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹-ExecutionJobVertex-çš„è¿æ¥"><a href="#æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹-ExecutionJobVertex-çš„è¿æ¥" class="headerlink" title="æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ ExecutionJobVertex çš„è¿æ¥"></a>æ‰§è¡Œè®¡åˆ’èŠ‚ç‚¹ ExecutionJobVertex çš„è¿æ¥</h4><p>æ„å»ºå®ŒèŠ‚ç‚¹åé€šè¿‡è¿æ¥ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ DAGã€è§ExecutionGraph attachJobGraph æ–¹æ³•ã€‘ï¼ŒconnectToPredecessors æ˜¯è¿æ¥æ‰§è¡ŒèŠ‚ç‚¹çš„æ ¸å¿ƒé€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ExecutionJobGraph line237</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectToPredecessors</span><span class="params">(Map&lt;IntermediateDataSetID, IntermediateResult&gt; intermediateDataSets)</span> <span class="keyword">throws</span> JobException </span>&#123;</div><div class="line"></div><div class="line">   List&lt;JobEdge&gt; inputs = jobVertex.getInputs();</div><div class="line"></div><div class="line">   ...</div><div class="line"></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> num = <span class="number">0</span>; num &lt; inputs.size(); num++) &#123;</div><div class="line">      JobEdge edge = inputs.get(num);</div><div class="line"></div><div class="line">      ...</div><div class="line"></div><div class="line">      <span class="comment">// fetch the intermediate result via ID. if it does not exist, then it either has not been created, or the order</span></div><div class="line">      <span class="comment">// in which this method is called for the job vertices is not a topological order</span></div><div class="line">      IntermediateResult ires = intermediateDataSets.get(edge.getSourceId());</div><div class="line">      <span class="keyword">if</span> (ires == <span class="keyword">null</span>) &#123;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> JobException(<span class="string">"Cannot connect this job graph to the previous graph. No previous intermediate result found for ID "</span></div><div class="line">               + edge.getSourceId());</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">this</span>.inputs.add(ires);</div><div class="line"></div><div class="line">      <span class="keyword">int</span> consumerIndex = ires.registerConsumer();</div><div class="line"></div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parallelism; i++) &#123;</div><div class="line">         ExecutionVertex ev = taskVertices[i];</div><div class="line">         ev.connectSource(num, ires, edge, consumerIndex);</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç®€è¦æ¦‚æ‹¬é€»è¾‘å¦‚ä¸‹ï¼š</p>
<ul>
<li>è®¾ç½®è¾“å…¥ IntermediateResult</li>
<li>å°†è‡ªå·±æ³¨å†Œåˆ°  IntermediateResultï¼Œç›®å‰ä¸€ä¸ª IntermediateResult åªæ”¯æŒä¸€ä¸ª æ¶ˆè´¹ ExecutionJobVertex èŠ‚ç‚¹</li>
<li>è®¾ç½®å¹¶å‘å­ task ExecutionVertex å’Œä¸­é—´ç»“æœ IntermediateResult çš„è¿æ¥å…³ç³»ï¼Œé€šè¿‡ ExecutionVertex çš„ connectSource  æ–¹æ³•è®¾ç½® ExecutionVertex çš„è¿æ¥ç­–ç•¥ï¼Œç­–ç•¥ä¸€å…±ä¸¤ç§ï¼š POINT_WISE ALL_TO_ALL å‰è€…ä¸Šæ¸¸ partition ä¸ä¸‹æ¸¸ consumers ä¹‹é—´æ˜¯ä¸€å¯¹å¤šå…³ç³»ï¼Œåè€…æ˜¯ all to all å…³ç³»ï¼Œè¿™é‡Œä¼šå°† ExecutionEdge åˆ›å»ºå‡ºæ¥å¹¶æ·»åŠ  consumer ä¸ºæ­¤ edgeã€partitionåœ¨ new ExecutionVertexæ—¶åˆ›å»ºå‡ºæ¥ï¼Œç”± ExecutionVertex æ„é€ å™¨å¯çŸ¥ä¸€ä¸ª ExecutionVertex ç”Ÿäº§ä¸€ä¸ª partitionï¼Œpartition number å°±æ˜¯ sub task indexã€‘</li>
</ul>
<h4 id="æ‰§è¡ŒèŠ‚ç‚¹å­ä»»åŠ¡-ExecutionVertex"><a href="#æ‰§è¡ŒèŠ‚ç‚¹å­ä»»åŠ¡-ExecutionVertex" class="headerlink" title="æ‰§è¡ŒèŠ‚ç‚¹å­ä»»åŠ¡ ExecutionVertex"></a>æ‰§è¡ŒèŠ‚ç‚¹å­ä»»åŠ¡ ExecutionVertex</h4><p>å…ˆçœ‹ä¸€ä¸‹ ExecutionVertex çš„åˆ›å»ºè¿‡ç¨‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ExecutionVertex</span><span class="params">(</span></span></div><div class="line">      ExecutionJobVertex jobVertex,</div><div class="line">      <span class="keyword">int</span> subTaskIndex,</div><div class="line">      IntermediateResult[] producedDataSets,</div><div class="line">      FiniteDuration timeout,</div><div class="line">      <span class="keyword">long</span> createTimestamp) &#123;</div><div class="line">   <span class="keyword">this</span>.jobVertex = jobVertex;</div><div class="line">   <span class="keyword">this</span>.subTaskIndex = subTaskIndex;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.resultPartitions = <span class="keyword">new</span> LinkedHashMap&lt;IntermediateResultPartitionID, IntermediateResultPartition&gt;(producedDataSets.length, <span class="number">1</span>);</div><div class="line"></div><div class="line">   <span class="keyword">for</span> (IntermediateResult result : producedDataSets) &#123;</div><div class="line">      IntermediateResultPartition irp = <span class="keyword">new</span> IntermediateResultPartition(result, <span class="keyword">this</span>, subTaskIndex);</div><div class="line">      result.setPartition(subTaskIndex, irp);</div><div class="line"></div><div class="line">      resultPartitions.put(irp.getPartitionId(), irp);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.inputEdges = <span class="keyword">new</span> ExecutionEdge[jobVertex.getJobVertex().getInputs().size()][];</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.priorExecutions = <span class="keyword">new</span> CopyOnWriteArrayList&lt;Execution&gt;();</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.currentExecution = <span class="keyword">new</span> Execution(</div><div class="line">      getExecutionGraph().getExecutionContext(),</div><div class="line">      <span class="keyword">this</span>,</div><div class="line">      <span class="number">0</span>,</div><div class="line">      createTimestamp,</div><div class="line">      timeout);</div><div class="line"></div><div class="line">   <span class="comment">// create a co-location scheduling hint, if necessary</span></div><div class="line">   CoLocationGroup clg = jobVertex.getCoLocationGroup();</div><div class="line">   <span class="keyword">if</span> (clg != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">this</span>.locationConstraint = clg.getLocationConstraint(subTaskIndex);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">this</span>.locationConstraint = <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.timeout = timeout;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€»è¾‘æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¾æ®å¯¹åº”çš„ ExecutionJobGraph ç”Ÿæˆçš„ä¸­é—´æ•°æ®é›† IntermediateResult çš„ä¸ªæ•°ç”Ÿæˆä¸€å®šä¸ªæ•°çš„ partitionï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ª IntermediateResult è¾“å‡ºä¸€ä¸ª partition</li>
<li>ç”Ÿæˆ Execution</li>
<li>é…ç½®èµ„æºç›¸å…³</li>
</ul>
<p>ä¸‹é¢é‡ç‚¹ä»‹ç»ä¸‹å…¶è¿æ¥ä¸Šæ¸¸ ExecutionVertex çš„è¿‡ç¨‹ï¼š</p>
<p>connectSource æ˜¯è¿æ¥çš„æ ¸å¿ƒé€»è¾‘ï¼Œé€»è¾‘å¦‚ä¸‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ExecutionVertex line250</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connectSource</span><span class="params">(<span class="keyword">int</span> inputNumber, IntermediateResult source, JobEdge edge, <span class="keyword">int</span> consumerNumber)</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="keyword">final</span> DistributionPattern pattern = edge.getDistributionPattern();</div><div class="line">   <span class="keyword">final</span> IntermediateResultPartition[] sourcePartitions = source.getPartitions();</div><div class="line"></div><div class="line">   ExecutionEdge[] edges;</div><div class="line"></div><div class="line">   <span class="keyword">switch</span> (pattern) &#123;</div><div class="line">      <span class="keyword">case</span> POINTWISE:</div><div class="line">         edges = connectPointwise(sourcePartitions, inputNumber);</div><div class="line">         <span class="keyword">break</span>;</div><div class="line"></div><div class="line">      <span class="keyword">case</span> ALL_TO_ALL:</div><div class="line">         edges = connectAllToAll(sourcePartitions, inputNumber);</div><div class="line">         <span class="keyword">break</span>;</div><div class="line"></div><div class="line">      <span class="keyword">default</span>:</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unrecognized distribution pattern."</span>);</div><div class="line"></div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">this</span>.inputEdges[inputNumber] = edges;</div><div class="line"></div><div class="line">   <span class="comment">// add the consumers to the source</span></div><div class="line">   <span class="comment">// for now (until the receiver initiated handshake is in place), we need to register the</span></div><div class="line">   <span class="comment">// edges as the execution graph</span></div><div class="line">   <span class="keyword">for</span> (ExecutionEdge ee : edges) &#123;</div><div class="line">      ee.getSource().addConsumer(ee, consumerNumber);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€»è¾‘æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>è·å– JobEdge çš„æ•°æ®åˆ†å‘ç­–ç•¥ï¼šå¦‚æœé shuffle æ“ä½œå°±æ˜¯ DistributionPattern.POINTWISE å¦åˆ™æ˜¯ DistributionPattern.ALL_TO_ALLå…·ä½“è§ä»£ç ï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//StreamingJobGraphGenerator line370</span></div><div class="line">StreamPartitioner&lt;?&gt; partitioner = edge.getPartitioner();</div><div class="line"><span class="keyword">if</span> (partitioner <span class="keyword">instanceof</span> ForwardPartitioner) &#123;</div><div class="line">   downStreamVertex.connectNewDataSetAsInput(</div><div class="line">      headVertex,</div><div class="line">      DistributionPattern.POINTWISE,</div><div class="line">      ResultPartitionType.PIPELINED,</div><div class="line">      <span class="keyword">true</span>);</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (partitioner <span class="keyword">instanceof</span> RescalePartitioner)&#123;</div><div class="line">   downStreamVertex.connectNewDataSetAsInput(</div><div class="line">      headVertex,</div><div class="line">      DistributionPattern.POINTWISE,</div><div class="line">      ResultPartitionType.PIPELINED,</div><div class="line">      <span class="keyword">true</span>);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">   downStreamVertex.connectNewDataSetAsInput(</div><div class="line">         headVertex,</div><div class="line">         DistributionPattern.ALL_TO_ALL,</div><div class="line">         ResultPartitionType.PIPELINED,</div><div class="line">         <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>æŒ‰ç…§ä¸åŒçš„åˆ†å‘ç­–ç•¥è¿æ¥ä¸Šæ¸¸</li>
</ul>
<p>DistributionPattern.ALL_TO_ALL å°±æ˜¯ç®€å•çš„å…¨è¿æ¥ï¼Œè¿™é‡Œå°±ä¸ä»‹ç»äº†ï¼Œåªä»‹ç»DistributionPattern.POINTWISE ç­–ç•¥ã€‚</p>
<p>è¯¥ç­–ç•¥è¿æ¥ execution vertex ä¸ä¸Šæ¸¸çš„ partitionsï¼Œä¼šå…ˆè·å–ä¸Šæ¸¸çš„ partition æ•°ä¸ æ­¤ ExecutionJobVertex çš„å¹¶å‘åº¦ï¼Œå¦‚æœä¸¤è€…å¹¶å‘åº¦ç›¸ç­‰ï¼Œåˆ™æ˜¯ ä¸€å¯¹ä¸€ è¿æ¥ï¼š</p>
<img src="/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/execution-vertex-one-to-one.png" alt="execution-vertex-one-to-one.png" title="execution-vertex-one-to-one.png">
<p>å¦‚æœ partition æ•°å°äº å¹¶å‘æ•° ï¼Œå­ task åªä¼šè¿æ¥ä¸€ä¸ªä¸Šæ¸¸ partitionï¼Œå…·ä½“å…³ç³»å¦‚ä¸‹å›¾ï¼š</p>
<img src="/2017/02/06/flinkç‰©ç†è®¡åˆ’ç”Ÿæˆ/execution-one-many.png" alt="execution-one-many.png" title="execution-one-many.png">
<p>å¦‚æœ partition æ•°å¤§äºå¹¶å‘æ•°ï¼Œå­ task ä¼šè¿æ¥å¤šä¸ªä¸Šæ¸¸ partitionï¼Œå…·ä½“è§ä¸‹å›¾ï¼š</p>
<p>execution-many-one.png](execution-many-one.png)</p>
<p>åˆ°è¿™é‡Œè¿è¡Œæ—¶æ‰§è¡Œè®¡åˆ’ ExecutionGraph çš„ç”Ÿæˆå°±ä»‹ç»å®Œäº†ğŸ˜„ä¸‹èŠ‚å°†å…ˆä»‹ç» JobManager çš„æ ¸å¿ƒç»„ä»¶</p>
]]></content>
    
    <summary type="html">
    
      flink ç‰©ç†è®¡åˆ’ç”Ÿæˆï¼Œä¸»è¦æ˜¯ JobManager è¿è¡Œæ—¶çš„æŠ½è±¡å’Œç®¡ç†ï¼Œå‰ä¸€ç« èŠ‚ä¸­æœ‰ä»‹ç»è¿‡ flink çš„é€»è¾‘è®¡åˆ’æŠ½è±¡ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œflink è¿›ä¸€æ­¥å°†é€»è¾‘è®¡åˆ’æŠ½è±¡æˆä¸æ‰§è¡ŒèŠ‚ç‚¹ä¿¡æ¯ç´§å¯†ç›¸å…³çš„ç‰©ç†è®¡åˆ’ï¼Œæ¥å¯¹ä½œä¸šçš„è°ƒåº¦ã€æ‰§è¡Œè¿›è¡Œç®¡ç†
    
    </summary>
    
      <category term="Streaming" scheme="https://danny0405.github.io/categories/Streaming/"/>
    
    
      <category term="flink" scheme="https://danny0405.github.io/tags/flink/"/>
    
  </entry>
  
  <entry>
    <title>flik åŸºæœ¬ç»„ä»¶å’Œé€»è¾‘è®¡åˆ’</title>
    <link href="https://danny0405.github.io/2016/12/03/Flink%E5%9F%BA%E6%9C%AC%E7%BB%84%E4%BB%B6%E5%92%8C%E9%80%BB%E8%BE%91%E8%AE%A1%E5%88%92/"/>
    <id>https://danny0405.github.io/2016/12/03/FlinkåŸºæœ¬ç»„ä»¶å’Œé€»è¾‘è®¡åˆ’/</id>
    <published>2016-12-03T03:59:30.000Z</published>
    <updated>2017-02-06T10:52:11.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¦‚è¦å’ŒèƒŒæ™¯"><a href="#æ¦‚è¦å’ŒèƒŒæ™¯" class="headerlink" title="æ¦‚è¦å’ŒèƒŒæ™¯"></a>æ¦‚è¦å’ŒèƒŒæ™¯</h2><p><em>flink</em>æ˜¯ä¸€ä¸ªè¢«èª‰ä¸º <em>the 4th G</em> çš„è®¡ç®—æ¡†æ¶ï¼Œä¸åŒçš„æ¡†æ¶ç‰¹æ€§åŠå…¶ä»£è¡¨é¡¹ç›®åˆ—è¡¨å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>ç¬¬ä¸€ä»£</th>
<th>ç¬¬äºŒä»£</th>
<th>ç¬¬ä¸‰ä»£</th>
<th>ç¬¬å››ä»£</th>
</tr>
</thead>
<tbody>
<tr>
<td>Batch</td>
<td><strong>Batch</strong> <strong>Interactive</strong></td>
<td><strong>Batch</strong> <strong>Interactive</strong> <strong>Near-Real-Time</strong> <strong>Interative-processing</strong></td>
<td><strong>Hybrid</strong> <strong>Interactive</strong> <strong>Real-Time-Streaming</strong> <strong>Native-Iterative-processing</strong></td>
</tr>
<tr>
<td></td>
<td>DAG Dataflows</td>
<td>RDD</td>
<td>Cyclic Dataflows</td>
</tr>
<tr>
<td>Hadoop MapReduce</td>
<td>TEZ</td>
<td>Spark</td>
<td>Flink</td>
</tr>
</tbody>
</table>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç»<em>flink</em>çš„æ ¸å¿ƒç»„ä»¶ä»¥åŠé€»è¾‘è®¡åˆ’çš„ç”Ÿæˆè¿‡ç¨‹</p>
<p><em>å‚è€ƒä»£ç åˆ†æ”¯ flink-1.1.2</em></p>
<h2 id="æ ¸å¿ƒç»„ä»¶ä»‹ç»"><a href="#æ ¸å¿ƒç»„ä»¶ä»‹ç»" class="headerlink" title="æ ¸å¿ƒç»„ä»¶ä»‹ç»"></a>æ ¸å¿ƒç»„ä»¶ä»‹ç»</h2><p><em>è¿™é‡Œåªä»‹ç» on yarn æ¨¡å¼ä¸‹çš„ç»„ä»¶</em></p>
<p><em>flink</em> çš„ on yarn æ¨¡å¼æ”¯æŒä¸¤ç§ä¸åŒçš„ç±»å‹ï¼š</p>
<ol>
<li>å•ä½œä¸šå•é›†ç¾¤</li>
<li>å¤šä½œä¸šå•é›†ç¾¤</li>
</ol>
<p>é¦–å…ˆä»‹ç» <em>å•ä½œä¸šå•é›†ç¾¤</em> çš„æ¶æ„ï¼Œå•ä½œä¸šå•é›†ç¾¤ä¸‹ä¸€ä¸ªæ­£å¸¸çš„ <em>flink</em> ç¨‹åºä¼šæ‹¥æœ‰ä»¥ä¸‹ç»„ä»¶</p>
<hr>
<p>job Cli: é detatched æ¨¡å¼ä¸‹çš„å®¢æˆ·ç«¯è¿›ç¨‹ï¼Œç”¨ä»¥è·å– yarn Application Master çš„è¿è¡ŒçŠ¶æ€å¹¶å°†æ—¥å¿—è¾“å‡ºæ‰ç»ˆç«¯</p>
<p>JobManager[JM]: è´Ÿè´£ä½œä¸šçš„è¿è¡Œæ—¶è®¡åˆ’ ExecutionGraph çš„ç”Ÿæˆã€ç‰©ç†è®¡åˆ’ç”Ÿæˆå’Œä½œä¸šè°ƒåº¦</p>
<p>TaskManager[TM]: è´Ÿè´£è¢«åˆ†å‘ task çš„æ‰§è¡Œã€å¿ƒè·³/çŠ¶æ€ä¸ŠæŠ¥ã€èµ„æºç®¡ç†</p>
<hr>
<p>æ•´ä½“çš„æ¶æ„å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="/2016/12/03/FlinkåŸºæœ¬ç»„ä»¶å’Œé€»è¾‘è®¡åˆ’/flink-on-yarn-arch.png" alt="flink on yarn" title="flink on yarn">
<p>ä¸‹é¢å°†ä»¥ä¸€æ¬¡ Job çš„æäº¤è¿‡ç¨‹æè¿° <em>flink</em> çš„å„ç»„ä»¶çš„ä½œç”¨åŠååŒ</p>
<h3 id="ä½œä¸šæäº¤æµç¨‹åˆ†æ"><a href="#ä½œä¸šæäº¤æµç¨‹åˆ†æ" class="headerlink" title="ä½œä¸šæäº¤æµç¨‹åˆ†æ"></a>ä½œä¸šæäº¤æµç¨‹åˆ†æ</h3><p>å•ä½œä¸šå•é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªä½œä¸šä¼šå¯åŠ¨ä¸€ä¸ª JMï¼Œå¹¶ä¾æ®ç”¨æˆ·çš„å‚æ•°ä¼ é€’å¯åŠ¨ç›¸åº”æ•°é‡çš„ TMï¼Œæ¯ä¸ª TM è¿è¡Œåœ¨ yarn çš„ä¸€ä¸ª container ä¸­ï¼Œ</p>
<p>ä¸€ä¸ªé€šå¸¸çš„ flink on yarn æäº¤å‘½ä»¤ï¼š<br><code>./bin/flink run -m yarn-cluster -yn 2 -j flink-demo-1.0.0-with-dependencies.jar â€”ytm 1024 -yst 4 -yjm 1024 â€”yarnname flink_demo_waimai_e</code><br><em>flink</em> åœ¨æ”¶åˆ°è¿™æ ·ä¸€æ¡å‘½ä»¤åä¼šé¦–å…ˆé€šè¿‡ Cli è·å– flink çš„é…ç½®ï¼Œå¹¶è§£æå‘½ä»¤è¡Œå‚æ•°ã€‚</p>
<h4 id="é…ç½®åŠ è½½"><a href="#é…ç½®åŠ è½½" class="headerlink" title="é…ç½®åŠ è½½"></a>é…ç½®åŠ è½½</h4><p><code>CliFrontend.java</code> æ˜¯ flink æäº¤ä½œä¸šçš„å…¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//CliFrontend line144</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">CliFrontend</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">   <span class="keyword">this</span>(getConfigurationDirectoryFromEnv());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œä¼šå°è¯•åŠ è½½ conf æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰ yaml æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶çš„å‘½åå¹¶æ²¡æœ‰å¼ºåˆ¶é™åˆ¶</p>
<h4 id="å‚æ•°è§£æ"><a href="#å‚æ•°è§£æ" class="headerlink" title="å‚æ•°è§£æ"></a>å‚æ•°è§£æ</h4><p>è§£æå‘½ä»¤è¡Œå‚æ•°çš„ç¬¬ä¸€æ­¥æ˜¯è·¯ç”±ç”¨æˆ·çš„å‘½ä»¤ï¼Œç„¶åäº¤ç”±<code>run</code>æ–¹æ³•å»å¤„ç†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//CliFrontend line993</span></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="keyword">return</span> SecurityUtils.runSecured(<span class="keyword">new</span> SecurityUtils.FlinkSecuredRunner&lt;Integer&gt;() &#123;</div><div class="line">	    <span class="function">Override</span></div><div class="line">	    <span class="keyword">public</span> Integer <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</div><div class="line">	        <span class="keyword">return</span> CliFrontend.<span class="keyword">this</span>.run(params);</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">		<span class="keyword">return</span> handleError(e);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥æ˜¯ç¨‹åºå‚æ•°è®¾ç½®è¿‡ç¨‹ï¼Œ<em>flink</em> å°† jaråŒ…è·¯å¾„å’Œå‚æ•°é…ç½®å°è£…æˆäº† <code>PackagedProgram</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//CliFrontend line223</span></div><div class="line">PackagedProgram program;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">   LOG.info(<span class="string">"Building program from JAR file"</span>);</div><div class="line">   program = buildProgram(options);</div><div class="line">&#125;</div><div class="line"><span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">   <span class="keyword">return</span> handleError(t);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="flinké›†ç¾¤çš„æ„å»º"><a href="#flinké›†ç¾¤çš„æ„å»º" class="headerlink" title="flinké›†ç¾¤çš„æ„å»º"></a>flinké›†ç¾¤çš„æ„å»º</h4><h5 id="é›†ç¾¤ç±»å‹çš„è§£æ"><a href="#é›†ç¾¤ç±»å‹çš„è§£æ" class="headerlink" title="é›†ç¾¤ç±»å‹çš„è§£æ"></a>é›†ç¾¤ç±»å‹çš„è§£æ</h5><p>è·å–å‚æ•°åä¸‹ä¸€æ­¥å°±æ˜¯é›†ç¾¤çš„æ„å»ºå’Œéƒ¨ç½²ï¼Œflink é€šè¿‡ ä¸¤ä¸ªä¸åŒçš„ <code>CustomCommandLine</code> æ¥å®ç°ä¸åŒé›†ç¾¤æ¨¡å¼çš„è§£æï¼Œåˆ†åˆ«æ˜¯ <code>FlinkYarnSessionCli</code>å’Œ <code>DefaultCLI</code> ã€åæ§½ä¸€ä¸‹ flink ç±»åçš„å‘½åè§„èŒƒã€‘è§£æå‘½ä»¤è¡Œå‚æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//CliFrontend line125</span></div><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">   <span class="comment">/** command line interface of the YARN session, with a special initialization here</span></div><div class="line">    *  to prefix all options with y/yarn. */</div><div class="line">   loadCustomCommandLine(<span class="string">"org.apache.flink.yarn.cli.FlinkYarnSessionCli"</span>, <span class="string">"y"</span>, <span class="string">"yarn"</span>);</div><div class="line">   customCommandLine.add(<span class="keyword">new</span> DefaultCLI());</div><div class="line">&#125;</div><div class="line">...</div><div class="line"><span class="comment">//line882 è¿™é‡Œå°†å†³å®šCliçš„ç±»å‹</span></div><div class="line">CustomCommandLine&lt;?&gt; activeCommandLine = getActiveCustomCommandLine(options.getCommandLine());</div></pre></td></tr></table></figure>
<p>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™è§£ææˆ Yarn Cluster ä»€ä¹ˆæ—¶å€™è§£ææˆ Standalone å‘¢ï¼Ÿç”±äº<code>FlinkYarnSessionCli</code>è¢«ä¼˜å…ˆæ·»åŠ åˆ°<code>customCommandLine</code>,æ‰€ä»¥ä¼šå…ˆè§¦å‘ä¸‹é¢è¿™æ®µé€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//FlinkYarnSessionCli line469</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isActive</span><span class="params">(CommandLine commandLine, Configuration configuration)</span> </span>&#123;</div><div class="line">   String jobManagerOption = commandLine.getOptionValue(ADDRESS_OPTION.getOpt(), <span class="keyword">null</span>);</div><div class="line">   <span class="keyword">boolean</span> yarnJobManager = ID.equals(jobManagerOption);</div><div class="line">   <span class="keyword">boolean</span> yarnAppId = commandLine.hasOption(APPLICATION_ID.getOpt());</div><div class="line">   <span class="keyword">return</span> yarnJobManager || yarnAppId || loadYarnPropertiesFile(commandLine, configuration) != <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºå¦‚æœç”¨æˆ·ä¼ å…¥äº† <code>-m</code>å‚æ•°æˆ–è€…<code>application id</code>æˆ–è€…é…ç½®äº†yarn properties æ–‡ä»¶ï¼Œåˆ™å¯åŠ¨yarn clusteræ¨¡å¼ï¼Œå¦åˆ™æ˜¯Standaloneæ¨¡å¼çš„é›†ç¾¤</p>
<h5 id="é›†ç¾¤éƒ¨ç½²"><a href="#é›†ç¾¤éƒ¨ç½²" class="headerlink" title="é›†ç¾¤éƒ¨ç½²"></a>é›†ç¾¤éƒ¨ç½²</h5><p>flinké€šè¿‡<code>YarnClusterDescriptor</code>æ¥æè¿°yarné›†ç¾¤çš„éƒ¨ç½²é…ç½®ï¼Œå…·ä½“å¯¹åº”çš„é…ç½®æ–‡ä»¶ä¸º<code>flink-conf.yaml</code>ï¼Œé€šè¿‡ä¸‹é¢è¿™æ®µé€»è¾‘è§¦å‘é›†ç¾¤éƒ¨ç½²ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//AbstractYarnClusterDescriptor line372</span></div><div class="line"><span class="comment">/**</span></div><div class="line"> * This method will block until the ApplicationMaster/JobManager have been</div><div class="line"> * deployed on YARN.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">protected</span> YarnClusterClient <span class="title">deployInternal</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div></pre></td></tr></table></figure>
<p>å¤§è‡´åˆ—ä¸‹è¿‡ç¨‹ï¼š</p>
<ul>
<li>check yarn é›†ç¾¤é˜Ÿåˆ—èµ„æºæ˜¯å¦æ»¡è¶³è¯·æ±‚</li>
<li>è®¾ç½® AM Contextã€å¯åŠ¨å‘½ä»¤ã€submission context</li>
<li>å¦‚æœå¼€å¯é«˜å¯ç”¨æ¨¡å¼ã€é€šè¿‡åå°„è°ƒç”¨ submission context çš„ä¸¤ä¸ªæ–¹æ³•ä¿®æ”¹å±æ€§ã€‘ keepContainersMethod    attemptFailuresValidityIntervalMethod ã€å’Œ Hadoop çš„ç‰ˆæœ¬æœ‰å…³ã€‘ç¬¬ä¸€ä¸ªå±æ€§è¡¨ç¤ºåº”ç”¨é‡è¯•æ—¶æ˜¯å¦ä¿ç•™ AM containerï¼Œç¬¬äºŒä¸ªå±æ€§è¡¨ç¤º æŒ‡å®š é—´éš”æ—¶é—´ä¹‹å†…åº”ç”¨å…è®¸å¤±è´¥é‡å¯çš„æ¬¡æ•°</li>
<li>ä¸Šä¼  ç”¨æˆ· jarã€flink-conf.yamlã€lib ç›®å½•ä¸‹æ‰€æœ‰çš„ jar åŒ…ã€logback log4jé…ç½®æ–‡ä»¶ åˆ° HDFS</li>
<li>é€šè¿‡ yarn client submit am context</li>
<li>å°†yarn client åŠç›¸å…³é…ç½®å°è£…æˆ YarnClusterClient è¿”å›</li>
</ul>
<p>çœŸæ­£åœ¨ AM ä¸­è¿è¡Œçš„ä¸»ç±»æ˜¯ <code>YarnApplicationMasterRunner</code>ï¼Œå®ƒçš„ <code>run</code>æ–¹æ³•åšäº†å¦‚ä¸‹å·¥ä½œï¼š</p>
<ul>
<li>å¯åŠ¨JobManager ActorSystem</li>
<li>å¯åŠ¨ flink ui</li>
<li>å¯åŠ¨<code>YarnFlinkResourceManager</code>æ¥è´Ÿè´£ä¸yarnçš„ResourceManageräº¤äº’ï¼Œç®¡ç†yarnèµ„æº</li>
<li>å¯åŠ¨ actor System supervise è¿›ç¨‹</li>
</ul>
<p>åˆ°è¿™é‡Œ JobManager å·²ç»å¯åŠ¨èµ·æ¥ï¼Œé‚£ä¹ˆ TaskManageræ˜¯ä»€ä¹ˆæ—¶å€™èµ·åŠ¨çš„å‘¢ï¼Ÿ</p>
<p>åœ¨ <code>YarnFlinkResourceManager</code>å¯åŠ¨çš„æ—¶å€™ä¼šé¢„å…ˆæ‰§è¡Œä¸€æ®µé€»è¾‘ã€Akka actorçš„preStartæ–¹æ³•ã€‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preStart</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// we start our leader retrieval service to make sure we get informed</span></div><div class="line">        <span class="comment">// about JobManager leader changes</span></div><div class="line">        leaderRetriever.start(<span class="keyword">new</span> LeaderRetrievalListener() &#123;</div><div class="line"></div><div class="line">		    <span class="meta">@Override</span></div><div class="line">		    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyLeaderAddress</span><span class="params">(String leaderAddress, UUID leaderSessionID)</span> </span>&#123;</div><div class="line">		        self().tell(</div><div class="line">						<span class="keyword">new</span> NewLeaderAvailable(leaderAddress, leaderSessionID),</div><div class="line">						ActorRef.noSender());</div><div class="line">		    &#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µé€»è¾‘ä¼šå…ˆå°è¯•è·å– JobManager çš„åœ°å€å¹¶ç»™è‡ªå·±å‘é€ä¸€ä¸ªè·¯ç”±æ¶ˆæ¯<code>NewLeaderAvailable</code>ï¼Œç„¶å<code>YarnFlinkResourceManager</code>ä¼šæŠŠè‡ªå·±æ³¨å†Œåˆ° <code>JobManager</code> ä¸­ï¼Œæ¥ç€<code>JobManager</code>ä¼šå‘é€ä¸€ä¸ªå›è°ƒå‘½ä»¤ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//JobManager line358</span></div><div class="line">sender ! decorateMessage(<span class="keyword">new</span> <span class="type">RegisterResourceManagerSuccessful</span>(self, taskManagerResources))</div></pre></td></tr></table></figure>
<p>æ¥ç€ä¼šè§¦å‘è¿™æ ·ä¸€æ®µé€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//FlinkResourceManager line555</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkWorkersPool</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> numWorkersPending = getNumWorkerRequestsPending();</div><div class="line">   <span class="keyword">int</span> numWorkersPendingRegistration = getNumWorkersPendingRegistration();</div><div class="line"></div><div class="line">   <span class="comment">// sanity checks</span></div><div class="line">   Preconditions.checkState(numWorkersPending &gt;= <span class="number">0</span>,</div><div class="line">      <span class="string">"Number of pending workers should never be below 0."</span>);</div><div class="line">   Preconditions.checkState(numWorkersPendingRegistration &gt;= <span class="number">0</span>,</div><div class="line">      <span class="string">"Number of pending workers pending registration should never be below 0."</span>);</div><div class="line"></div><div class="line">   <span class="comment">// see how many workers we want, and whether we have enough</span></div><div class="line">   <span class="keyword">int</span> allAvailableAndPending = startedWorkers.size() +</div><div class="line">      numWorkersPending + numWorkersPendingRegistration;</div><div class="line"></div><div class="line">   <span class="keyword">int</span> missing = designatedPoolSize - allAvailableAndPending;</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (missing &gt; <span class="number">0</span>) &#123;</div><div class="line">      requestNewWorkers(missing);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å°†æ‰€æœ‰çš„ TS èµ·åŠ¨èµ·æ¥ï¼Œè¿™æ ·ä¸€ä¸ª flink é›†ç¾¤ä¾¿æ„å»ºå‡ºæ¥äº†ã€‚ä¸‹é¢é™„å›¾è§£é‡Šä¸‹è¿™ä¸ªæµç¨‹ï¼š</p>
<img src="/2016/12/03/FlinkåŸºæœ¬ç»„ä»¶å’Œé€»è¾‘è®¡åˆ’/flink-cluster-start-flow.png" alt="flink-cluster-start-flow" title="flink-cluster-start-flow">
<ol>
<li>flink cli è§£ææœ¬åœ°ç¯å¢ƒé…ç½®ï¼Œå¯åŠ¨ <code>ApplicationMaster</code></li>
<li>åœ¨ <code>ApplicationMaster</code> ä¸­å¯åŠ¨ <code>JobManager</code></li>
<li>åœ¨ <code>ApplicationMaster</code> ä¸­å¯åŠ¨<code>YarnFlinkResourceManager</code></li>
<li><code>YarnFlinkResourceManager</code>ç»™<code>JobManager</code>å‘é€æ³¨å†Œä¿¡æ¯</li>
<li><code>YarnFlinkResourceManager</code>æ³¨å†ŒæˆåŠŸåï¼Œ<code>JobManager</code>ç»™<code>YarnFlinkResourceManager</code>å‘é€æ³¨å†ŒæˆåŠŸä¿¡æ¯</li>
<li><code>YarnFlinkResourceManage</code>çŸ¥é“è‡ªå·±æ³¨å†ŒæˆåŠŸååƒ<code>ResourceManager</code>ç”³è¯·å’Œ<code>TaskManager</code>æ•°é‡å¯¹ç­‰çš„ container</li>
<li>åœ¨containerä¸­å¯åŠ¨<code>TaskManager</code></li>
<li><code>TaskManager</code>å°†è‡ªå·±æ³¨å†Œåˆ°<code>JobManager</code>ä¸­</li>
</ol>
<p><em>æ¥ä¸‹æ¥ä¾¿æ˜¯ç¨‹åºçš„æäº¤å’Œè¿è¡Œ</em></p>
<p>ç¨‹åºåœ¨<code>CliFrontend</code>ä¸­è¢«æäº¤åï¼Œä¼šè§¦å‘è¿™æ ·ä¸€æ®µé€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ClusterClient 304</span></div><div class="line">	<span class="function"><span class="keyword">public</span> JobSubmissionResult <span class="title">run</span><span class="params">(PackagedProgram prog, <span class="keyword">int</span> parallelism)</span></span></div><div class="line">			<span class="keyword">throws</span> ProgramInvocationException</div><div class="line">	&#123;</div><div class="line">		Thread.currentThread().setContextClassLoader(prog.getUserCodeClassLoader());</div><div class="line">		...</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (prog.isUsingInteractiveMode()) &#123;</div><div class="line">			LOG.info(<span class="string">"Starting program in interactive mode"</span>);</div><div class="line">			ContextEnvironmentFactory factory = <span class="keyword">new</span> ContextEnvironmentFactory(<span class="keyword">this</span>, prog.getAllLibraries(),</div><div class="line">					prog.getClasspaths(), prog.getUserCodeClassLoader(), parallelism, isDetached(),</div><div class="line">					prog.getSavepointPath());</div><div class="line">			ContextEnvironment.setAsContext(factory);</div><div class="line"></div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="comment">// invoke main method</span></div><div class="line">				prog.invokeInteractiveModeForExecution();</div><div class="line">				...</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">finally</span> &#123;</div><div class="line">				ContextEnvironment.unsetContext();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"PackagedProgram does not have a valid invocation mode."</span>);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„åˆ°æœ‰ä¸€æ®µ<code>prog.invokeInteractiveModeForExecution()</code>ï¼Œè¿™æ˜¯å®¢æˆ·ç«¯ç”Ÿæˆåˆæ­¥é€»è¾‘è®¡åˆ’çš„æ ¸å¿ƒé€»è¾‘ï¼Œä¸‹é¢å°†è¯¦ç»†ä»‹ç»</p>
<h3 id="å®¢æˆ·ç«¯é€»è¾‘è®¡åˆ’"><a href="#å®¢æˆ·ç«¯é€»è¾‘è®¡åˆ’" class="headerlink" title="å®¢æˆ·ç«¯é€»è¾‘è®¡åˆ’"></a>å®¢æˆ·ç«¯é€»è¾‘è®¡åˆ’</h3><p>ä¸Šé¢æåˆ°<code>prog.invokeInteractiveModeForExecution()</code>è¿™æ®µé€»è¾‘ä¼šè§¦å‘å®¢æˆ·ç«¯é€»è¾‘è®¡åˆ’çš„ç”Ÿæˆï¼Œé‚£ä¹ˆæ˜¯æ€æ ·ä¸€ä¸ªè¿‡ç¨‹å‘¢ï¼Ÿå…¶å®è¿™é‡Œåªæ˜¯è°ƒç”¨äº†ç”¨æˆ·jaråŒ…çš„ä¸»å‡½æ•°ï¼ŒçœŸæ­£çš„è§¦å‘ç”Ÿæˆè¿‡ç¨‹ç”±ç”¨æˆ·ä»£ç çš„æ‰§è¡Œæ¥å®Œæˆã€‚ä¾‹å¦‚ç”¨æˆ·å†™äº†è¿™æ ·ä¸€æ®µ flink ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">object FlinkDemo extends App with Logging&#123;</div><div class="line">  <span class="function">override def <span class="title">main</span><span class="params">(args: Array[String])</span>: Unit </span>=&#123;</div><div class="line">    val properties = <span class="keyword">new</span> Properties</div><div class="line">    properties.setProperty(<span class="string">"bootstrap.servers"</span>, DemoConfig.kafkaBrokerList)</div><div class="line"></div><div class="line"> properties.setProperty(<span class="string">"zookeeper.connect"</span>,<span class="string">"host01:2181,host02:2181,host03:2181/kafka08"</span>)</div><div class="line">    properties.setProperty(<span class="string">"group.id"</span>, <span class="string">"flink-demo-waimai-e"</span>)</div><div class="line"></div><div class="line">    val env = StreamExecutionEnvironment.getExecutionEnvironment</div><div class="line">    env.enableCheckpointing(<span class="number">5000L</span>, CheckpointingMode.EXACTLY_ONCE) <span class="comment">//checkpoint every 5 seconds.</span></div><div class="line">    val stream = env.addSource(<span class="keyword">new</span> FlinkKafkaConsumer08[String](<span class="string">"log.waimai_e"</span>, <span class="keyword">new</span> SimpleStringSchema, properties)).setParallelism(<span class="number">2</span>)</div><div class="line">    val counts = stream.name(<span class="string">"log.waimai_e"</span>).map(toPoiIdTuple(_)).filter(_._2 != <span class="keyword">null</span>)</div><div class="line">      .keyBy(<span class="number">0</span>)</div><div class="line">      .timeWindow(Time.seconds(<span class="number">5</span>))</div><div class="line">      .sum(<span class="number">1</span>)</div><div class="line"></div><div class="line">    counts.addSink(sendToKafka(_))</div><div class="line">    env.execute()</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„åˆ°è¿™æ ·ä¸€æ®µ<code>val env = StreamExecutionEnvironment.getExecutionEnvironment</code>ï¼Œè¿™æ®µä»£ç ä¼šè·å–å®¢æˆ·ç«¯çš„ç¯å¢ƒé…ç½®ï¼Œå®ƒé¦–å…ˆä¼šè½¬åˆ°è¿™æ ·ä¸€æ®µé€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//StreamExecutionEnvironment 1256</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StreamExecutionEnvironment <span class="title">getExecutionEnvironment</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (contextEnvironmentFactory != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">return</span> contextEnvironmentFactory.createExecutionEnvironment();</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">// because the streaming project depends on "flink-clients" (and not the other way around)</span></div><div class="line">   <span class="comment">// we currently need to intercept the data set environment and create a dependent stream env.</span></div><div class="line">   <span class="comment">// this should be fixed once we rework the project dependencies</span></div><div class="line"></div><div class="line">   ExecutionEnvironment env = ExecutionEnvironment.getExecutionEnvironment();</div></pre></td></tr></table></figure>
<p><code>ExecutionEnvironment.getExecutionEnvironment();</code>è·å–ç¯å¢ƒçš„é€»è¾‘å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ExecutionEnvironment line1137</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutionEnvironment <span class="title">getExecutionEnvironment</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">return</span> contextEnvironmentFactory == <span class="keyword">null</span> ?</div><div class="line">         createLocalEnvironment() : contextEnvironmentFactory.createExecutionEnvironment();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>contextEnvironmentFactory</code>æ˜¯ä¸€ä¸ªé™æ€æˆå‘˜ï¼Œæ—©åœ¨<code>ContextEnvironment.setAsContext(factory)</code>å·²ç»è§¦å‘è¿‡åˆå§‹åŒ–äº†ï¼Œå…¶ä¸­åŒ…å«äº†å¦‚ä¸‹çš„ç¯å¢ƒä¿¡æ¯:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ContextEnvironmentFactory line51</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ContextEnvironmentFactory</span><span class="params">(ClusterClient client, List&lt;URL&gt; jarFilesToAttach,</span></span></div><div class="line">      List&lt;URL&gt; classpathsToAttach, ClassLoader userCodeClassLoader, <span class="keyword">int</span> defaultParallelism,</div><div class="line">      <span class="keyword">boolean</span> isDetached, String savepointPath)</div><div class="line">&#123;</div><div class="line">   <span class="keyword">this</span>.client = client;</div><div class="line">   <span class="keyword">this</span>.jarFilesToAttach = jarFilesToAttach;</div><div class="line">   <span class="keyword">this</span>.classpathsToAttach = classpathsToAttach;</div><div class="line">   <span class="keyword">this</span>.userCodeClassLoader = userCodeClassLoader;</div><div class="line">   <span class="keyword">this</span>.defaultParallelism = defaultParallelism;</div><div class="line">   <span class="keyword">this</span>.isDetached = isDetached;</div><div class="line">   <span class="keyword">this</span>.savepointPath = savepointPath;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„ client å°±æ˜¯ä¸Šé¢ç”Ÿæˆçš„ <code>YarnClusterClient</code>ï¼Œå…¶å®ƒçš„æ„æ€è¾ƒæ˜æ˜¾ï¼Œå°±ä¸å¤šåšè§£é‡Šäº†ã€‚</p>
<p>ç”¨æˆ·åœ¨æ‰§è¡Œ<code>val env = StreamExecutionEnvironment.getExecutionEnvironment</code>è¿™æ ·ä¸€æ®µé€»è¾‘åä¼šå¾—åˆ°ä¸€ä¸ª<code>StreamContextEnvironment</code>ï¼Œå…¶ä¸­å°è£…äº† streaming çš„ä¸€äº›æ‰§è¡Œé…ç½® ã€buffer time outç­‰ã€‘ï¼Œå¦å¤–ä¿å­˜äº†ä¸Šé¢æåˆ°çš„ <code>ContextEnvironmen</code>t çš„å¼•ç”¨ã€‚</p>
<p>åˆ°è¿™é‡Œå…³äº streaming éœ€è¦çš„æ‰§è¡Œç¯å¢ƒä¿¡æ¯å·²ç»è®¾ç½®å®Œæˆã€‚</p>
<h4 id="åˆæ­¥é€»è¾‘è®¡åˆ’-StreamGraph-çš„ç”Ÿæˆ"><a href="#åˆæ­¥é€»è¾‘è®¡åˆ’-StreamGraph-çš„ç”Ÿæˆ" class="headerlink" title="åˆæ­¥é€»è¾‘è®¡åˆ’ StreamGraph çš„ç”Ÿæˆ"></a>åˆæ­¥é€»è¾‘è®¡åˆ’ StreamGraph çš„ç”Ÿæˆ</h4><p>æ¥ä¸‹æ¥ç”¨æˆ·ä»£ç æ‰§è¡Œåˆ°<code>val stream = env.addSource(new FlinkKafkaConsumer08</code>ï¼Œè¿™æ®µé€»è¾‘å®é™…ä¼šç”Ÿæˆä¸€ä¸ª<code>DataStream</code>æŠ½è±¡ï¼Œ<code>DataStream</code>æ˜¯flinkå…³äºstreamingæŠ½è±¡çš„æœ€æ ¸å¿ƒæŠ½è±¡ï¼Œåç»­æ‰€æœ‰çš„ç®—å­è½¬æ¢éƒ½ä¼šåœ¨<code>DataStream</code>ä¸Šæ¥å®Œæˆï¼Œä¸Šé¢çš„<code>addSource</code>æ“ä½œä¼šè§¦å‘ä¸‹é¢è¿™æ®µé€»è¾‘:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;OUT&gt; <span class="function">DataStreamSource&lt;OUT&gt; <span class="title">addSource</span><span class="params">(SourceFunction&lt;OUT&gt; function, String sourceName, TypeInformation&lt;OUT&gt; typeInfo)</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="keyword">if</span>(typeInfo == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (function <span class="keyword">instanceof</span> ResultTypeQueryable) &#123;</div><div class="line">         typeInfo = ((ResultTypeQueryable&lt;OUT&gt;) function).getProducedType();</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">         <span class="keyword">try</span> &#123;</div><div class="line">            typeInfo = TypeExtractor.createTypeInfo(</div><div class="line">                  SourceFunction.class,</div><div class="line">                  function.getClass(), <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">         &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InvalidTypesException e) &#123;</div><div class="line">            typeInfo = (TypeInformation&lt;OUT&gt;) <span class="keyword">new</span> MissingTypeInfo(sourceName, e);</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">boolean</span> isParallel = function <span class="keyword">instanceof</span> ParallelSourceFunction;</div><div class="line"></div><div class="line">   clean(function);</div><div class="line">   StreamSource&lt;OUT, ?&gt; sourceOperator;</div><div class="line">   <span class="keyword">if</span> (function <span class="keyword">instanceof</span> StoppableFunction) &#123;</div><div class="line">      sourceOperator = <span class="keyword">new</span> StoppableStreamSource&lt;&gt;(cast2StoppableSourceFunction(function));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">      sourceOperator = <span class="keyword">new</span> StreamSource&lt;&gt;(function);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> DataStreamSource&lt;&gt;(<span class="keyword">this</span>, typeInfo, sourceOperator, isParallel, sourceName);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç®€è¦æ€»ç»“ä¸‹ä¸Šé¢çš„é€»è¾‘ï¼š</p>
<ul>
<li>è·å–æ•°æ®æº source çš„ output ä¿¡æ¯ TypeInformation</li>
<li>ç”Ÿæˆ StreamSource sourceOperator</li>
<li>ç”Ÿæˆ DataStreamSourceã€å°è£…äº† sourceOperatorã€‘ï¼Œå¹¶è¿”å›</li>
<li>å°† StreamTransformation æ·»åŠ åˆ°ç®—å­åˆ—è¡¨ transformations ä¸­ã€åªæœ‰ è½¬æ¢ transform æ“ä½œæ‰ä¼šæ·»åŠ ç®—å­ï¼Œå…¶å®ƒéƒ½åªæ˜¯æš‚æ—¶åšäº† transformation çš„å åŠ å°è£…ã€‘</li>
<li>åç»­ä¼šåœ¨ DataStream ä¸Šåšæ“ä½œ</li>
</ul>
<p>è¯¥è¾“å‡º<code>DataStreamSource</code>ç»§æ‰¿è‡ª<code>SingleOutputStreamOperator</code>å…·ä½“çš„ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p>
<img src="/2016/12/03/FlinkåŸºæœ¬ç»„ä»¶å’Œé€»è¾‘è®¡åˆ’/flink-datastream-extend.png" alt="flink-datastream-extend" title="flink-datastream-extend">
<p>è€Œç”Ÿæˆçš„ StreamSource operator èµ°çš„æ˜¯å¦ä¸€å¥—ç»§æ‰¿æ¥å£ï¼š</p>
<img src="/2016/12/03/FlinkåŸºæœ¬ç»„ä»¶å’Œé€»è¾‘è®¡åˆ’/stream-operator-extend.png" alt="stream-operator-extend" title="stream-operator-extend">
<p>DataStreamSource æ˜¯ä¸€ä¸ª DataStream <strong>æ•°æ®æµ</strong>æŠ½è±¡ï¼ŒStreamSource æ˜¯ä¸€ä¸ª StreamOperator <strong>ç®—å­</strong>æŠ½è±¡ï¼Œåœ¨ flink ä¸­ä¸€ä¸ª DataStream å°è£…äº†ä¸€æ¬¡æ•°æ®æµè½¬æ¢ï¼Œä¸€ä¸ª StreamOperator å°è£…äº†ä¸€ä¸ªå‡½æ•°æ¥å£ï¼Œæ¯”å¦‚ mapã€reduceã€keyByç­‰ã€‚<em>å…³äºç®—å­çš„ä»‹ç»ä¼šå¦èµ·ä¸€èŠ‚ï¼šflinkç®—å­çš„å£°æ˜å‘¨æœŸ</em></p>
<p>å¯ä»¥çœ‹åˆ°åœ¨ DataStream ä¸Šå¯ä»¥è¿›è¡Œä¸€ç³»åˆ—çš„æ“ä½œ(map filter ç­‰)ï¼Œæ¥çœ‹ä¸€ä¸ªå¸¸è§„æ“ä½œæ¯”å¦‚ map ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//DataStream line503</span></div><div class="line"><span class="keyword">public</span> &lt;R&gt; <span class="function">SingleOutputStreamOperator&lt;R&gt; <span class="title">map</span><span class="params">(MapFunction&lt;T, R&gt; mapper)</span> </span>&#123;</div><div class="line"></div><div class="line">   TypeInformation&lt;R&gt; outType = TypeExtractor.getMapReturnTypes(clean(mapper), getType(),</div><div class="line">         Utils.getCallLocationName(), <span class="keyword">true</span>);</div><div class="line"></div><div class="line">   <span class="keyword">return</span> transform(<span class="string">"Map"</span>, outType, <span class="keyword">new</span> StreamMap&lt;&gt;(clean(mapper)));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸€ä¸ªmapæ“ä½œä¼šè§¦å‘ä¸€æ¬¡ transformï¼Œé‚£ä¹ˆtransformåšäº†ä»€ä¹ˆå·¥ä½œå‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//DataStream line1020</span></div><div class="line"><span class="meta">@PublicEvolving</span></div><div class="line"><span class="keyword">public</span> &lt;R&gt; <span class="function">SingleOutputStreamOperator&lt;R&gt; <span class="title">transform</span><span class="params">(String operatorName, TypeInformation&lt;R&gt; outTypeInfo, OneInputStreamOperator&lt;T, R&gt; operator)</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="comment">// read the output type of the input Transform to coax out errors about MissingTypeInfo</span></div><div class="line">   transformation.getOutputType();</div><div class="line"></div><div class="line">   OneInputTransformation&lt;T, R&gt; resultTransform = <span class="keyword">new</span> OneInputTransformation&lt;&gt;(</div><div class="line">         <span class="keyword">this</span>.transformation,</div><div class="line">         operatorName,</div><div class="line">         operator,</div><div class="line">         outTypeInfo,</div><div class="line">         environment.getParallelism());</div><div class="line"></div><div class="line">   <span class="meta">@SuppressWarnings</span>(&#123; <span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span> &#125;)</div><div class="line">   SingleOutputStreamOperator&lt;R&gt; returnStream = <span class="keyword">new</span> SingleOutputStreamOperator(environment, resultTransform);</div><div class="line"></div><div class="line">   getExecutionEnvironment().addOperator(resultTransform);</div><div class="line"></div><div class="line">   <span class="keyword">return</span> returnStream;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸€æ­¥ç”Ÿæˆäº†ä¸€ä¸ª <code>StreamTransformation</code>å¹¶ä»¥æ­¤ä½œä¸ºæˆå‘˜å˜é‡å°è£…æˆå¦ä¸€ä¸ª DataStream è¿”å›ï¼Œ<code>StreamTransformation</code>æ˜¯ flinkå…³äºæ•°æ®æµè½¬æ¢çš„æ ¸å¿ƒæŠ½è±¡ï¼Œåªæœ‰éœ€è¦ transform çš„æµæ‰ä¼šç”Ÿæˆæ–°çš„DataStream ç®—å­ï¼Œåé¢ä¼šè¯¦ç»†è§£é‡Šï¼Œæ³¨æ„ä¸Šé¢æœ‰è¿™ä¸€è¡Œ<code>getExecutionEnvironment().addOperator(resultTransform)</code>flinkä¼šå°†transformationç»´æŠ¤èµ·æ¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//StreamExecutionEnvironment line 1237</span></div><div class="line"><span class="meta">@Internal</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addOperator</span><span class="params">(StreamTransformation&lt;?&gt; transformation)</span> </span>&#123;</div><div class="line">   Preconditions.checkNotNull(transformation, <span class="string">"transformation must not be null."</span>);</div><div class="line">   <span class="keyword">this</span>.transformations.add(transformation);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰€ä»¥ï¼Œç”¨æˆ·çš„ä¸€è¿ä¸²æ“ä½œ map joinç­‰å®é™…ä¸Šåœ¨ DataStream ä¸Šåšäº†è½¬æ¢ï¼Œå¹¶ä¸”flinkå°†è¿™äº› <code>StreamTransformation</code> ç»´æŠ¤èµ·æ¥ï¼Œä¸€ç›´åˆ°æœ€åï¼Œç”¨æˆ·æ‰§è¡Œ <code>env.execute()</code>è¿™æ ·ä¸€æ®µé€»è¾‘ï¼ŒStreamGraph çš„æ„å»ºæ‰ç®—çœŸæ­£å¼€å§‹â€¦</p>
<p>ç”¨æˆ·åœ¨æ‰§è¡Œ<code>env.execute()</code>ä¼šè§¦å‘è¿™æ ·ä¸€æ®µé€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//StreamContextEnvironment line51   </span></div><div class="line"><span class="function"><span class="keyword">public</span> JobExecutionResult <span class="title">execute</span><span class="params">(String jobName)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">      Preconditions.checkNotNull(<span class="string">"Streaming Job name should not be null."</span>);</div><div class="line"></div><div class="line">      StreamGraph streamGraph = <span class="keyword">this</span>.getStreamGraph();</div><div class="line">      streamGraph.setJobName(jobName);</div><div class="line"></div><div class="line">      transformations.clear();</div><div class="line"></div><div class="line">      <span class="comment">// execute the programs</span></div><div class="line">      <span class="keyword">if</span> (ctx <span class="keyword">instanceof</span> DetachedEnvironment) &#123;</div><div class="line">         LOG.warn(<span class="string">"Job was executed in detached mode, the results will be available on completion."</span>);</div><div class="line">         ((DetachedEnvironment) ctx).setDetachedPlan(streamGraph);</div><div class="line">         <span class="keyword">return</span> DetachedEnvironment.DetachedJobExecutionResult.INSTANCE;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">         <span class="keyword">return</span> ctx.getClient().runBlocking(streamGraph, ctx.getJars(), ctx.getClasspaths(), ctx.getUserCodeClassLoader(), ctx.getSavepointPath());</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç åšäº†ä¸¤ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>é¦–å…ˆä½¿ç”¨ <code>StreamGraphGenerator</code> äº§ç”Ÿ StreamGraph</li>
<li>ä½¿ç”¨ Client è¿è¡Œ stream graph</li>
</ul>
<p>é‚£ä¹ˆ<code>StreamGraphGenerator</code> åšäº†å“ªäº›æ“ä½œå‘¢ï¼Ÿ</p>
<p><code>StreamGraphGenerator</code>ä¼šä¾æ®æ·»åŠ ç®—å­æ—¶ä¿å­˜çš„ transformations ä¿¡æ¯ç”Ÿæˆ job graph ä¸­çš„èŠ‚ç‚¹ï¼Œå¹¶åˆ›å»ºèŠ‚ç‚¹è¿æ¥ï¼Œåˆ†æµæ“ä½œ å¦‚ union,select,split ä¸ä¼šæ·»åŠ è¾¹ï¼Œåªä¼šåˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹æˆ–åœ¨ä¸Šæœ‰èŠ‚ç‚¹æ·»åŠ  selector</p>
<p>è¿™é‡Œä¼šå°† StreamTransformation è½¬æ¢ä¸º StreamNodeï¼ŒStreamNode ä¿å­˜äº†ç®—å­çš„ä¿¡æ¯ã€ä¼šå¦å¤–ä»‹ç»ã€‘ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="./transformation-to-node.png" width="535" height="300" alt="transformation-to-node.png" align="center"></p>
<p>åˆ°è¿™é‡Œç”± <code>StreamNode</code> æ„æˆçš„ DAG å›¾ <code>StreamGraph</code>å°±ç”Ÿæˆäº†</p>
<p>ä¸è¿‡ åœ¨æäº¤ç»™ client çš„æ—¶å€™ï¼Œflink ä¼šåšè¿›ä¸€æ­¥çš„ä¼˜åŒ–:</p>
<p> <code>StreamGraph</code> å°†è¿›ä¸€æ­¥è½¬æ¢ä¸º <code>JobGraph</code>ï¼Œè¿™ä¸€æ­¥å·¥ä½œç”± <code>StreamingJobGraphGenerator</code> æ¥å®Œæˆï¼Œä¸ºä»€ä¹ˆè¦åšè¿™ä¸€æ­¥è½¬æ¢å‘¢ï¼Ÿä¸»è¦å› ä¸ºæœ‰å¯ä»¥ chain çš„ç®—å­ï¼Œè¿™é‡Œè¿›ä¸€æ­¥å°† StreamNode è½¬æ¢ä¸º JobVertexï¼Œä¸»è¦å·¥ä½œæ˜¯å°†å¯ä»¥ chain çš„ç®—å­åˆå¹¶ã€è¿™ä¸€æ­¥ä¼˜åŒ–æ˜¯é»˜è®¤æ‰“å¼€çš„ã€‘ï¼Œå¹¶è®¾ç½®èµ„æºï¼Œé‡è¯•ç­–ç•¥ç­‰ï¼Œæœ€ç»ˆç”Ÿæˆå¯ä»¥æäº¤ç»™ JobManager çš„ JobGraph</p>
<h4 id="ä¼˜åŒ–çš„é€»è¾‘è®¡åˆ’-JobGraph-çš„ç”Ÿæˆ"><a href="#ä¼˜åŒ–çš„é€»è¾‘è®¡åˆ’-JobGraph-çš„ç”Ÿæˆ" class="headerlink" title="ä¼˜åŒ–çš„é€»è¾‘è®¡åˆ’ JobGraph çš„ç”Ÿæˆ"></a>ä¼˜åŒ–çš„é€»è¾‘è®¡åˆ’ JobGraph çš„ç”Ÿæˆ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//StreamingJobGraphGenerator line181</span></div><div class="line"><span class="function"><span class="keyword">private</span> List&lt;StreamEdge&gt; <span class="title">createChain</span><span class="params">(</span></span></div><div class="line">      Integer startNodeId,</div><div class="line">      Integer currentNodeId,</div><div class="line">      Map&lt;Integer, <span class="keyword">byte</span>[]&gt; hashes) &#123;</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (!builtVertices.contains(startNodeId)) &#123;</div><div class="line"></div><div class="line">      List&lt;StreamEdge&gt; transitiveOutEdges = <span class="keyword">new</span> ArrayList&lt;StreamEdge&gt;();</div><div class="line"></div><div class="line">      List&lt;StreamEdge&gt; chainableOutputs = <span class="keyword">new</span> ArrayList&lt;StreamEdge&gt;();</div><div class="line">      List&lt;StreamEdge&gt; nonChainableOutputs = <span class="keyword">new</span> ArrayList&lt;StreamEdge&gt;();</div><div class="line"></div><div class="line">      <span class="keyword">for</span> (StreamEdge outEdge : streamGraph.getStreamNode(currentNodeId).getOutEdges()) &#123;</div><div class="line">         <span class="keyword">if</span> (isChainable(outEdge)) &#123;</div><div class="line">            chainableOutputs.add(outEdge);</div><div class="line">         &#125; <span class="keyword">else</span> &#123;</div><div class="line">            nonChainableOutputs.add(outEdge);</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">for</span> (StreamEdge chainable : chainableOutputs) &#123;</div><div class="line">         transitiveOutEdges.addAll(createChain(startNodeId, chainable.getTargetId(), hashes));</div><div class="line">      &#125;</div><div class="line">     ...</div></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„æ–¹æ³•æ˜¯ç®—å­ chain çš„æ ¸å¿ƒæ“ä½œï¼Œç®€è¦æ¦‚æ‹¬ä¸‹ï¼š</p>
<ul>
<li>å¦‚æœä»æ­¤ start node å¼€å§‹æœªç”Ÿæˆè¿‡ JobVertexï¼Œåˆ™æ‰§è¡Œ chainé€»è¾‘ï¼Œç”±äºæ˜¯é€’å½’æ“ä½œï¼Œä¼šå…ˆæ·±åº¦ä¼˜å…ˆéå†ï¼Œå°†æºèŠ‚ç‚¹å¼€å§‹åˆ°ç¬¬ä¸€ä¸ªä¸å¯ chain çš„ StreamNode ä¹‹é—´çš„ç®—å­åš chain æ“ä½œã€å…ˆç®—å¶å­èŠ‚ç‚¹çš„ chainï¼Œä¾æ¬¡å¾€æ ¹èŠ‚ç‚¹è®¡ç®—ã€‘</li>
<li>line 207 é‡åˆ°ä¸å¯ chain çš„è¾¹ï¼Œå¼€å§‹æ·±åº¦éå†ç”Ÿæˆ JobVertex</li>
<li>line 216 å°† StreamNode çš„è¾“å…¥è¾“å‡ºé…ç½®ï¼ŒåŒ…æ‹¬åºåˆ—åŒ–é…ç½®ç­‰è®¾ç½®åˆ°ä¸Šé¢çš„ StreamingConfig ä¸­ï¼Œå¹¶åœ¨ vertexConfigs ä¸­ä¿å­˜èµ·æ¥ï¼Œå¦‚æœæ˜¯ æ–°ç”Ÿæˆçš„ JobVertexï¼Œèµ·å¯¹åº”çš„ StreamingConfig ä¼šä»¥ start node id ä¸º key è¿›è¡Œä¿å­˜</li>
<li>transitiveOutEdges ä¿å­˜çš„è¯¥èŠ‚ç‚¹ä¸‹æ¸¸æ‰€æœ‰çš„ non chain_able  edgesï¼Œæœ€ç»ˆçš„æ–¹æ³•ä¼šè¿”å›æ­¤æ•°æ®ç»“æ„</li>
<li>è¿æ¥ start node å’Œæ‰€æœ‰çš„ transitiveOutEdges ã€åœ¨è¾“å…¥ JobVertex åˆ›å»º IntermediateDataSetï¼Œpartitionç±»å‹ä¸º pipelineï¼Œç”Ÿæˆ JobEdgeã€‘</li>
<li>å¦‚æœæ˜¯æ–°ç”ŸæˆJobVertexï¼Œç»§ç»­è®¾ç½®configï¼ŒåŒ…æ‹¬ chain startï¼Œæ‰€æœ‰ç‰©ç†è¾“å‡ºï¼ŒåŠç›´æ¥é€»è¾‘è¾“å‡ºã€chained configç­‰</li>
<li>å¦‚æœä¸æ˜¯æ–°ç”Ÿæˆ JobVertexï¼Œç›´æ¥chain configs</li>
</ul>
<p>è¿™é‡Œæ€»ç»“ä¸‹JobGraphçš„æ„å»ºè¿‡ç¨‹ï¼Œè§ä¸‹å›¾:</p>
<img src="/2016/12/03/FlinkåŸºæœ¬ç»„ä»¶å’Œé€»è¾‘è®¡åˆ’/flink-job-graph-create.png" alt="flink-job-graph-create" title="flink-job-graph-create">
<p>å¤§è‡´è¿‡ç¨‹æ€»ç»“å¦‚ä¸‹ï¼š</p>
<ul>
<li>ç”±<code>DataStream</code>ä¸Šçš„æ“ä½œç”Ÿæˆ<code>StreamTransformation</code>åˆ—è¡¨</li>
<li>ä»<code>StreamTransformation</code>çš„ç”Ÿæˆå…³ç³»åˆ›å»º<code>StreamNode</code>å’Œ<code>StreamEdge</code></li>
<li>åšç®—å­chainï¼Œåˆå¹¶æˆ <code>JobVertex</code>ï¼Œå¹¶ç”Ÿæˆ <code>JobEdge</code></li>
</ul>
<p>ä¸€ä¸ª JobVertex ä»£è¡¨ä¸€ä¸ªé€»è¾‘è®¡åˆ’çš„èŠ‚ç‚¹ï¼Œå°±æ˜¯ DAG å›¾ä¸Šçš„é¡¶ç‚¹ï¼Œæœ‰ç‚¹ç±»ä¼¼äº Storm çš„ bolt æˆ– spoutï¼Œç”Ÿæˆä¸€ä¸ª JobVertex çš„é€»è¾‘å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//StreamingJobGenerator line258</span></div><div class="line"><span class="function"><span class="keyword">private</span> StreamConfig <span class="title">createJobVertex</span><span class="params">(</span></span></div><div class="line">      Integer streamNodeId,</div><div class="line">      Map&lt;Integer, <span class="keyword">byte</span>[]&gt; hashes) &#123;</div><div class="line"></div><div class="line">   JobVertex jobVertex;</div><div class="line">   ...</div><div class="line">   JobVertexID jobVertexId = <span class="keyword">new</span> JobVertexID(hash);</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (streamNode.getInputFormat() != <span class="keyword">null</span>) &#123;</div><div class="line">      jobVertex = <span class="keyword">new</span> InputFormatVertex(</div><div class="line">            chainedNames.get(streamNodeId),</div><div class="line">            jobVertexId);</div><div class="line">      TaskConfig taskConfig = <span class="keyword">new</span> TaskConfig(jobVertex.getConfiguration());</div><div class="line">      taskConfig.setStubWrapper(<span class="keyword">new</span> UserCodeObjectWrapper&lt;Object&gt;(streamNode.getInputFormat()));</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">      jobVertex = <span class="keyword">new</span> JobVertex(</div><div class="line">            chainedNames.get(streamNodeId),</div><div class="line">            jobVertexId);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   jobVertex.setInvokableClass(streamNode.getJobVertexClass());</div><div class="line"></div><div class="line">   ...</div><div class="line"></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> StreamConfig(jobVertex.getConfiguration());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>è¿™é‡Œæœ‰ä¸¤æ®µé€»è¾‘å€¼å¾—æ³¨æ„ï¼Œç¬¬ä¸€æ˜¯æ•°æ®æºèŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œç¬¬äºŒæ˜¯è¿è¡Œæ—¶æ‰§è¡Œç±» InvokableClass çš„è®¾ç½®</em></p>
<p><code>streamNode.getInputFormat()</code>æ˜¯åˆ¤æ–­æ˜¯å¦æ˜¯æ•°æ®æºèŠ‚ç‚¹çš„é€»è¾‘ï¼Œå¦‚æœæ˜¯æ•°æ®æºèŠ‚ç‚¹ï¼Œè¿™é‡Œä¼šå°†ç”¨æˆ·ä»£ç ã€è¿™é‡Œä¸º InputFormat.class çš„å­ç±»ã€‘è®¾ç½®è¿› JobVertex çš„é…ç½®ä¸­ï¼Œå¹¶åœ¨ JobManager æ‰§è¡Œæäº¤ä½œä¸šå‘½ä»¤çš„æ—¶å€™åšåˆå§‹åŒ–ï¼Œä¼šåœ¨ Flink ç‰©ç†è®¡åˆ’ç”Ÿæˆä¸€èŠ‚ä»‹ç»ã€‚</p>
<p><code>jobVertex.setInvokableClass</code>æ˜¯è®¾ç½®è¿è¡Œæ—¶çš„æ‰§è¡Œç±»ï¼Œé€šè¿‡è¿™ä¸ªç±»å†è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„ operatorï¼Œæ˜¯ flink task ä¸­çœŸæ­£è¢«æ‰§è¡Œçš„ç±»ï¼Œå…·ä½“ä¼šåœ¨ flink-task-runtime ä¸€èŠ‚ä¸­è¯¦ç»†ä»‹ç»ã€‚</p>
<p>è‡³æ­¤ JobGraph ç”Ÿæˆï¼Œå¹¶æ‰”ç»™ JobManager æ‰§è¡ŒğŸ˜</p>
]]></content>
    
    <summary type="html">
    
      Flink æºç ï¼ŒåŒ…æ‹¬åŸºæœ¬ç»„ä»¶å’Œå®¢æˆ·ç«¯é€»è¾‘è®¡åˆ’çš„ç”Ÿæˆ
    
    </summary>
    
      <category term="Streaming" scheme="https://danny0405.github.io/categories/Streaming/"/>
    
    
      <category term="flink" scheme="https://danny0405.github.io/tags/flink/"/>
    
  </entry>
  
</feed>
